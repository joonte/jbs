import{_ as K}from"./EmptyStateBlock-BaR9js3E.js";import{_ as q}from"./BlockAdditionalServices-BALrMbkE.js";import{_ as z}from"./ButtonDefault-BIBStZbJ.js";import{_ as J}from"./StatusBadge-CjHHKSUG.js";import{_ as Q}from"./ClausesKeeper-CTja-fCz.js";import{_ as W}from"./BlockBalanceAgreement-qtspRQ_B.js";import{O as X,u as Y,x as Z,r as C,f as D,g as ee,H as te,c,b as _,a as r,h as k,t as d,w as P,E as re,F as x,i as B,C as U,d as se,o as i,e as V}from"./index-CmCGXBst.js";import{u as oe}from"./services-C54cnl9l.js";import{_ as ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./bootstrap-vue-next-DwS3lKQb.js";import"./ServiceListOrderSelection-DUe6fwsE.js";import"./TotalAmount.vue_vue_type_script_setup_true_lang-CXrtmBc-.js";import"./BasicInput-KlObNzdO.js";import"./component-0WedTVCo.js";import"./BlockSelectContract-uyQ-oMQe.js";import"./contracts-P7YPBhEI.js";import"./multiselect-DhoC9bwZ.js";import"./IconClose-B_k4TzXM.js";const le={class:"tw-px-4 md:tw-px-8"},ne={key:0,class:"section-label"},ie={class:"tw-flex tw-items-center tw-gap-8 tw-border-b tw-border-gray-200 tw-mt-4 tw-whitespace-nowrap tw-mb-6"},ce={key:0,class:"section-body"},de={class:"ordered-services-list"},ue={class:"ordered-service-header"},ve={class:"ordered-service-name"},_e={class:"ordered-service-status"},me={class:"ordered-service-details"},pe={class:"ordered-service-info"},Se={key:0},fe={class:"ordered-service-actions"},De={class:"section-body"},be={key:2,class:"loading"},we={key:0,class:"tw-px-4 md:tw-px-8 tw-mb-6"},Ie={class:"total-block"},he={class:"total-block__row"},Oe={class:"total-block__col"},ke={class:"total-block__col"},ye={class:"total-block__col"},ge={class:"total-block__row total-block__row--big"},Ce={class:"total-block__col"},xe={__name:"DSServices",setup(Ee){const L=ee(),b=se(),u=X(),I=oe(),m=Y(),p=Z("emitter");p.on("updateDSIDPage",()=>{m.fetchUserOrders()});const a=C([]),E=C(!0),h=C(!1),l=D(()=>u?.dsOrders?Object.keys(u.dsOrders).map(t=>u.dsOrders[t]).find(t=>t&&String(t.OrderID)===String(L.params.id)):null),R=D(()=>!l.value?.SchemeID||!u?.DSSchemes?null:u.DSSchemes[l.value.SchemeID]),$=D(()=>!l.value||!R.value?null:{ServiceID:l.value.ServiceID,ServersGroupID:R.value.ServersGroupID}),w=D(()=>I?.ServicesList||{}),y=D(()=>{if(!l.value?.OrderID||!m?.userOrders)return[];const t=l.value.OrderID;return Object.keys(m.userOrders).map(n=>m.userOrders[n]).filter(n=>n?.DependOrderID==t&&n?.ServiceID&&w.value[n.ServiceID]).sort((n,S)=>Number(n?.ID)-Number(S?.ID))}),A=D(()=>{if(!a.value||!Array.isArray(a.value))return 0;let t=0;return a.value.forEach(e=>{e&&typeof e.Price=="number"&&(t+=e.Price)}),N(t)});function F(t){a.value=t||[]}function N(t){return t==null?"0.00":Number(t).toFixed(2)||"0.00"}function M(t,e){let s="Orders";e==5e4?s="ExtraIPOrders":e==51e3?s="ISPswOrders":e==52e3&&(s="DNSmanagerOrders"),p.emit("open-modal",{component:"StatusHistory",data:{modeID:s,rowID:t}})}function T(t){const e=Object.values(w.value).find(v=>v.ID===t);if(!e){b.push(`/AdditionalServices/${t}`);return}const s=e.Code;s==="Default"||s==="DNSmanager"||s==="ISPsw"||s==="ExtraIP"?b.push(`/AdditionalServices/${t}`):b.push(`/${s}Orders/${t}`)}async function j(){if(!(!a.value||!Array.isArray(a.value)||a.value.length===0))for(const t of a.value){if(!t)continue;let e="SUCCESS",s=w.value[t.ServiceID]?.Code;const v={Code:s,DependOrderID:l.value?.OrderID,...t,ContractID:l.value?.ContractID};try{const{result:n,info:S}=await I.ServiceOrder(v);if(n==="SUCCESS"){let f={};s==="Default"?f.ServiceOrderID=S?.ServiceOrderID:f[`${s}OrderID`]=S?.ServiceOrderID;const g=await I.ServiceOrderPay(s,f);let{result:O}=g;O==="SUCCESS"?(p.emit("open-modal",{component:"SuccessMessage",data:{message:"Дополнительные услуги успешно заказаны!"}}),a.value=[],await m.fetchUserOrders(),b.push("/AdditionalServices")):O==="BASKET"&&b.push("/Basket")}else e="ERROR",p.emit("open-modal",{component:"ErrorMessage",data:{message:"Ошибка при заказе дополнительных услуг"}})}catch(n){console.error("Ошибка при заказе услуги:",n),e="ERROR",p.emit("open-modal",{component:"ErrorMessage",data:{message:"Ошибка при заказе дополнительных услуг"}})}if(e==="ERROR")break}}async function H(){h.value=!0;try{await j()}catch(t){console.error("Ошибка при заказе услуг:",t),p.emit("open-modal",{component:"ErrorMessage",data:{message:"Произошла ошибка при заказе услуг"}})}finally{h.value=!1}}return te(async()=>{try{await u.fetchDSOrders(),await u.fetchDSSchemes(),await I.fetchServices(),await m.fetchUserOrders()}catch(t){console.error("Ошибка загрузки данных:",t)}finally{E.value=!1}}),(t,e)=>{const s=W,v=re("RouterLink"),n=Q,S=J,f=z,g=q,O=K;return i(),c(x,null,[_(s),r("div",le,[r("div",null,[e[4]||(e[4]=r("h1",{class:"section-title"},"Дополнительные услуги",-1)),l.value?(i(),c("div",ne,"Выделенный сервер # "+d(l.value?.OrderID),1)):k("",!0),r("div",ie,[_(v,{class:"tw-py-2 tw-cursor-pointer -tw-mb-[1px]","active-class":"tw-text-sky-400 tw-border-b-2 tw-border-sky-400",to:`/DSOrders/${l.value?.OrderID}`},{default:P(()=>e[2]||(e[2]=[V(" Сервер ",-1)])),_:1,__:[2]},8,["to"]),_(v,{class:"tw-py-2 tw-cursor-pointer -tw-mb-[1px]","active-class":"tw-text-sky-400 tw-border-b-2 tw-border-sky-400",to:`/Services/${l.value?.OrderID}`},{default:P(()=>e[3]||(e[3]=[V(" Услуги ",-1)])),_:1,__:[3]},8,["to"])])]),_(n),y.value&&y.value.length>0?(i(),c("div",ce,[e[5]||(e[5]=r("h3",{class:"section-subtitle"},"Заказанные услуги",-1)),r("div",de,[(i(!0),c(x,null,B(y.value,o=>(i(),c("div",{class:"ordered-service-item",key:o.ID},[r("div",ue,[r("div",ve,d(w.value[o?.ServiceID]?.Name||o?.ServiceName||`Услуга #${o?.ServiceID}`),1),r("div",_e,[_(S,{status:o?.StatusID,"status-table":"Orders",onClick:G=>M(o?.ID,o?.ServiceID),class:"tw-cursor-pointer"},null,8,["status","onClick"])])]),r("div",me,[r("div",pe,[r("span",null,"Заказ # "+d(o?.ID),1),o?.DaysRemainded?(i(),c("span",Se," Осталось дней: "+d(o?.DaysRemainded),1)):k("",!0)])]),r("div",fe,[_(f,{class:"btn--sm",label:"Перейти к заказу",onClick:G=>T(o?.ID)},null,8,["onClick"])])]))),128))])])):k("",!0),r("div",De,[l.value&&$.value?(i(),U(g,{key:0,modelValue:a.value,"onUpdate:modelValue":[e[0]||(e[0]=o=>a.value=o),F],"service-search-params":$.value},null,8,["modelValue","service-search-params"])):E.value?(i(),c("div",be,"Загрузка...")):(i(),U(O,{key:1,label:"Заказ не найден"}))])]),a.value&&a.value.length>0?(i(),c("div",we,[r("div",Ie,[r("div",he,[e[6]||(e[6]=r("div",{class:"total-block__col"},"Дополнительные услуги",-1)),r("div",Oe,d(A.value)+" ₽",1)]),(i(!0),c(x,null,B(a.value,o=>(i(),c("div",{class:"total-block__row no-divider",key:o.ServiceID},[r("div",ke,d(w.value[o?.ServiceID]?.Name),1),r("div",ye,d(N(o?.Price))+" ₽",1)]))),128)),r("div",ge,[e[7]||(e[7]=r("div",{class:"total-block__col"},"Итого к оплате",-1)),r("div",Ce,d(A.value)+" ₽",1)])]),_(f,{class:"btn--wide",disabled:!a.value||a.value.length===0||h.value,"is-loading":h.value,label:"Заказать дополнительные услуги",onClick:e[1]||(e[1]=o=>H())},null,8,["disabled","is-loading"])])):k("",!0)],64)}}},Je=ae(xe,[["__scopeId","data-v-1acc75fa"]]);export{Je as default};
