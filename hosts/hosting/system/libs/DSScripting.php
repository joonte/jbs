<?php
#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('libs/HTTP.php',)))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
function DSScripting_Create($Settings,$Attribs){
	/******************************************************************************/
	// параметры управляющего сервера, параметры управляемого сервера
	$__args_types = Array('array','array');
	#-------------------------------------------------------------------------------
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	// создаём файл с настрйоками
	$SettingsFile = DSScripting_SaveFile($Settings,$Attribs);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$File = $Settings['Params']['Action'];
	#-------------------------------------------------------------------------------
	# проверяем наличие введённого пути к скрипту
	if($File){
		#-------------------------------------------------------------------------------
		# находим полный путь к файлу
		if(SubStr($File,0,1) != '/')
			$File = SPrintF('%s/hosts/%s/scripts/%s',SYSTEM_PATH,HOST_ID,$File);
		#-------------------------------------------------------------------------------
		# проверяем наличие файла по этому пути
		if(!File_Exists($File))
			return new gException('FILE_NOT_FOUND',SPrintF("Файл '%s' не найден",$File));
		#-------------------------------------------------------------------------------
		Exec(SPrintF('"%s" "Create" "%s" 2>&1',$File,$SettingsFile),$Out,$ReturnValue);
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[DSScripting_Create]: exec return code = %s, Out = %s',$ReturnValue,print_r($Out,true)));
		#-------------------------------------------------------------------------------
		// удаляем файл. результат - наверное не важен...
		DSScripting_DeleteFile($SettingsFile);
		#-------------------------------------------------------------------------------
		if($ReturnValue != 0)
			return new gException('ERROR_EXECUTE_COMMAND','Произошла ошибка при выполнении команды назначенной статусу');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
function DSScripting_Active($Settings,$Attribs = Array()){
	/******************************************************************************/
	$__args_types = Array('array','array');
	#-------------------------------------------------------------------------------
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	#$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// создаём файл с настрйоками
	$SettingsFile = DSScripting_SaveFile($Settings,$Attribs);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$File = $Settings['Params']['Action'];
	#-------------------------------------------------------------------------------
	# проверяем наличие введённого пути к скрипту
	if($File){
		#-------------------------------------------------------------------------------
		# находим полный путь к файлу
		if(SubStr($File,0,1) != '/')
			$File = SPrintF('%s/hosts/%s/scripts/%s',SYSTEM_PATH,HOST_ID,$File);
		#-------------------------------------------------------------------------------
		# проверяем наличие файла по этому пути
		if(!File_Exists($File))
			return new gException('FILE_NOT_FOUND',SPrintF("Файл '%s' не найден",$File));
		#-------------------------------------------------------------------------------
		Exec(SPrintF('"%s" "Active" "%s" 2>&1',$File,$SettingsFile),$Out,$ReturnValue);
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[DSScripting_Active]: exec return code = %s, Out = %s',$ReturnValue,print_r($Out,true)));
		#-------------------------------------------------------------------------------
		// удаляем файл. результат - наверное не важен...
		DSScripting_DeleteFile($SettingsFile);
		#-------------------------------------------------------------------------------
		if($ReturnValue != 0)
			return new gException('ERROR_EXECUTE_COMMAND','Произошла ошибка при выполнении команды назначенной статусу');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
function DSScripting_Delete($Settings,$Attribs = Array()){
	/******************************************************************************/
	$__args_types = Array('array','array');
	#-------------------------------------------------------------------------------
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	#$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// создаём файл с настрйоками
	$SettingsFile = DSScripting_SaveFile($Settings,$Attribs);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$File = $Settings['Params']['Action'];
	#-------------------------------------------------------------------------------
	# проверяем наличие введённого пути к скрипту
	if($File){
		#-------------------------------------------------------------------------------
		# находим полный путь к файлу
		if(SubStr($File,0,1) != '/')
			$File = SPrintF('%s/hosts/%s/scripts/%s',SYSTEM_PATH,HOST_ID,$File);
		#-------------------------------------------------------------------------------
		# проверяем наличие файла по этому пути
		if(!File_Exists($File))
			return new gException('FILE_NOT_FOUND',SPrintF("Файл '%s' не найден",$File));
		#-------------------------------------------------------------------------------
		Exec(SPrintF('"%s" "Delete" "%s" 2>&1',$File,$SettingsFile),$Out,$ReturnValue);
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[DSScripting_Delete]: exec return code = %s, Out = %s',$ReturnValue,print_r($Out,true)));
		#-------------------------------------------------------------------------------
		// удаляем файл. результат - наверное не важен...
		DSScripting_DeleteFile($SettingsFile);
		#-------------------------------------------------------------------------------
		if($ReturnValue != 0)
			return new gException('ERROR_EXECUTE_COMMAND','Произошла ошибка при выполнении команды назначенной статусу');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
function DSScripting_Suspend($Settings,$Attribs = Array()){
	/******************************************************************************/
	$__args_types = Array('array','array');
	#-------------------------------------------------------------------------------
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	#$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// создаём файл с настрйоками
	$SettingsFile = DSScripting_SaveFile($Settings,$Attribs);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$File = $Settings['Params']['Action'];
	#-------------------------------------------------------------------------------
	# проверяем наличие введённого пути к скрипту
	if($File){
		#-------------------------------------------------------------------------------
		# находим полный путь к файлу
		if(SubStr($File,0,1) != '/')
			$File = SPrintF('%s/hosts/%s/scripts/%s',SYSTEM_PATH,HOST_ID,$File);
		#-------------------------------------------------------------------------------
		# проверяем наличие файла по этому пути
		if(!File_Exists($File))
			return new gException('FILE_NOT_FOUND',SPrintF("Файл '%s' не найден",$File));
		#-------------------------------------------------------------------------------
		Exec(SPrintF('"%s" "Suspend" "%s" 2>&1',$File,$SettingsFile),$Out,$ReturnValue);
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[DSScripting_Suspend]: exec return code = %s, Out = %s',$ReturnValue,print_r($Out,true)));
		#-------------------------------------------------------------------------------
		// удаляем файл. результат - наверное не важен...
		DSScripting_DeleteFile($SettingsFile);
		#-------------------------------------------------------------------------------
		if($ReturnValue != 0)
			return new gException('ERROR_EXECUTE_COMMAND','Произошла ошибка при выполнении команды назначенной статусу');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# Функции используемые для внутреннего употребления =)
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# надо вынести сюда кусок повторяющийся во всех функциях
function DSScripting_Build_HTTP($Settings){
	/******************************************************************************/
	$__args_types = Array('array');
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	$authinfo = SPrintF('%s:%s',$Settings['Login'],$Settings['Password']);
	#-------------------------------------------------------------------------------
	$HTTP = Array(
			'Address'	=> $Settings['Params']['IP'],
			'Port'		=> $Settings['Port'],
			'Host'		=> $Settings['Address'],
			'Protocol'	=> $Settings['Protocol'],
			'Hidden'	=> $authinfo,
			'IsLogging'	=> $Settings['Params']['IsLogging']
			);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return $HTTP;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// путь к файлу куда скидываются настройки сервера
function DSScripting_SaveFile($Settings,$Attribs){
	/******************************************************************************/
	$__args_types = Array('array','array');
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	// определяем путь к файлу
	$Tmp = System_Element('tmp');
	if(Is_Error($Tmp))
		return ERROR | @Trigger_Error('[system/libs/DSScripting]: не удалось найти временную папку');
	#-------------------------------------------------------------------------------
	$File = SPrintF('%s/files/%s',$Tmp,UniqID('DS'));
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// готовим настройки 
	$Content = Array('#!/bin/sh');
	#-------------------------------------------------------------------------------
	// настройки управляющего сервера
	$Array = Array_ToLine($Settings);
	#-------------------------------------------------------------------------------
	foreach(Array_Keys($Array) as $Key){
		#-------------------------------------------------------------------------------
		$Name = SPrintF('Settings%s',Str_Replace('.','',$Key));
		$Content[] = SPrintF('%s="%s"',$Name,$Array[$Key]);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// настройки тарифа
	$Array = Array_ToLine($Attribs);
	#-------------------------------------------------------------------------------
	foreach(Array_Keys($Array) as $Key){
		#-------------------------------------------------------------------------------
		$Name = SPrintF('Scheme%s',Str_Replace('.','',$Key));
		$Content[] = SPrintF('%s="%s"',$Name,$Array[$Key]);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	// сохраняем настройки в файл
	$IsWrited = IO_Write($File,Implode("\n",$Content),TRUE);
	if(Is_Error($IsWrited))
		return ERROR | @Trigger_Error('[system/libs/DSScripting->SaveFile]: не удалось сохранить файл');
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return $File;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// путь к файлу куда скидываются настройки управляющего и управлемого серверов
function DSScripting_DeleteFile($File){
	/******************************************************************************/
	$__args_types = Array('string');
	$__args__ = Func_Get_Args(); Eval(FUNCTION_INIT);
	/******************************************************************************/
	// удаляем файл с настройками
	if(!UnLink($File))
		return new gException('CANNOT_DELETE_FILE',SPrintF('Не удалось удалить файл: %s',$File));
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}





?>
