<?php
#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Params','StatusID','Period');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
// если заказ несуществует - возвращаем пустой массив
if(!In_Array($StatusID,Array('Active','Suspended','Deleted','OnService')))
	return Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// настройки графиков
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Tasks']['Types']['ServerAccountsResources'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// функция сортировки
if(!Function_Exists('CMP2')){
	#-----------------------------------------------------------------------------
	function CMP2($a,$b){
		#-----------------------------------------------------------------------------
		if ($a['SortID'] == $b['SortID'])
			return 0;
		#-----------------------------------------------------------------------------
		return ($a['SortID'] < $b['SortID']) ? -1 : 1;
		#-----------------------------------------------------------------------------
	}
	#-----------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// достаём аттрибуты графиков, нет смысла их хранить для каждого юзера
$Config = Config();
$Template = $Config['Other']['Graphs'];
#-------------------------------------------------------------------------------
// сортируем
UASort($Template,'CMP2');
$TemplateKeys = Array_Keys($Template);
//Debug(SPrintF('[comp/Formats/GraphOut]: Array_Keys($Template) = %s',Implode(',',Array_Keys($Template))));
#-------------------------------------------------------------------------------
// копируем в выхлоп то что пришло. кроме гарфиков и данных там могут быть другие параметры, чтоб не потерять
$Out = $Params;
#-------------------------------------------------------------------------------
// переделываем графики
if(IsSet($Params['Graphs'])){
	#-------------------------------------------------------------------------------
	// удаляем старый массив с графиком - иначе сортировка останется та, что пришла
	UnSet($Out['Graphs']);
	#-------------------------------------------------------------------------------
	// перебираем шаблоны графиков из конфига
	foreach(Array_Keys($Template) as $Key){
		#-------------------------------------------------------------------------------
		// перебираем графики
		foreach(Array_Keys($Params['Graphs']) as $Key2){
			#-------------------------------------------------------------------------------
			if($Key != $Key2)
				continue;
			#-------------------------------------------------------------------------------
			#-------------------------------------------------------------------------------
			// ставим шаблон
			$Out['Graphs'][$Key2] = $Template[$Key];
			#-------------------------------------------------------------------------------
			// добавляем лимит
			$Out['Graphs'][$Key2]['Limit'] = $Params['Graphs'][$Key2]['Limit'];
			#-------------------------------------------------------------------------------
			// создаём массив с данными гарфика заново, пустой
			$Out['Graphs'][$Key2]['Data'] = Array();
			#-------------------------------------------------------------------------------
			// перебираем значения для графика, вносим в массив
			foreach(Array_Keys($Params['Graphs'][$Key2]['Data']) as $Key3){
				#-------------------------------------------------------------------------------
				// выхлоп: [0] - данные, [1] - время (TimeStamp)
				// вносим, если попадает в заданный период
				if($Key3 > $Period)
					$Out['Graphs'][$Key2]['Data'][] = Array($Params['Graphs'][$Key2]['Data'][$Key3],$Key3);
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
			// удаляем ненужные поля
			UnSet($Out['Graphs'][$Key2]['Keys']);
			UnSet($Out['Graphs'][$Key2]['SortID']);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// добавляем аттрибуты к последним данным, и меняем сортировку
if(IsSet($Params['Last'])){
	#-------------------------------------------------------------------------------
	// удаляем старый массив с графиком - иначе сортировка останется та, что пришла
	UnSet($Out['Last']);
	#-------------------------------------------------------------------------------
	// перебираем шаблоны графиков из конфига
	foreach(Array_Keys($Template) as $Key){
		#-------------------------------------------------------------------------------
		// перебираем графики
		foreach(Array_Keys($Params['Last']) as $Key2){
			#-------------------------------------------------------------------------------
			if($Key != $Key2)
				continue;
			#-------------------------------------------------------------------------------
			//Debug(SPrintF('[comp/Formats/GraphOut]: совпали Key = %s; Key2 = %s',$Key,$Key2));
			#-------------------------------------------------------------------------------
			// ставим шаблон
			$Out['Last'][$Key2] = $Template[$Key];
			#-------------------------------------------------------------------------------
			// вносим данные
			$Out['Last'][$Key2]['Used'] = $Params['Last'][$Key2]['Used'];
			#-------------------------------------------------------------------------------
			// вносим лимит, если он задан
			if(IsSet($Params['Last'][$Key2]['Limit']))
				$Out['Last'][$Key2]['Limit'] = $Params['Last'][$Key2]['Limit'];
			#-------------------------------------------------------------------------------
			#-------------------------------------------------------------------------------
			// удаляем ненужные поля
			UnSet($Out['Last'][$Key2]['Keys']);
			UnSet($Out['Last'][$Key2]['SortID']);
			#-------------------------------------------------------------------------------
			#-------------------------------------------------------------------------------
			// проставляем статус, что всё хорошо, если плохо - потом поменяем
			$Out['Last'][$Key2]['Status'] = 'Ok';
			#-------------------------------------------------------------------------------
			// проверяем, есть ли в списке того, о чём алертим, этот параметр
			if(!In_Array($Key2,Explode(',',$Settings['Status'])))
				continue;
			#-------------------------------------------------------------------------------
			// и что лимит не нулевой
			if(!$Out['Last'][$Key2]['Limit'])
				continue;
			#-------------------------------------------------------------------------------
			//Debug(SPrintF('[comp/Formats/GraphOut]: Лимит = %s; Показания = %s',$Out['Last'][$Key2]['Limit'],$Out['Last'][$Key2]['Used']));
			#-------------------------------------------------------------------------------
			// если лимит и показания - числа - сравниваем. иначе - проверяем равно или нет
			if(Is_Numeric($Out['Last'][$Key2]['Limit']) && Is_Numeric($Out['Last'][$Key2]['Used'])){
				#-------------------------------------------------------------------------------
				// 80%
				if(($Out['Last'][$Key2]['Used']/$Out['Last'][$Key2]['Limit'])*100 > 80)
					$Out['Last'][$Key]['Status'] = 'Warning';
				#-------------------------------------------------------------------------------
				// 90%
				if(($Out['Last'][$Key2]['Used']/$Out['Last'][$Key2]['Limit'])*100 > 90)
					$Out['Last'][$Key2]['Status'] = 'Critical';
				#-------------------------------------------------------------------------------
			}else{
				#-------------------------------------------------------------------------------
				if($Out['Last'][$Key2]['Limit'] == $Out['Last'][$Key2]['Used'])
					$Out['Last'][$Key2]['Status'] = 'Critical';
				#-------------------------------------------------------------------------------
				// и убираем лимит
				UnSet($Out['Last'][$Key2]['Limit']);
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// если заказ заблокирован - вешаем алерт
if(In_Array($StatusID,Array('Suspended','Deleted','OnService'))){
	#-------------------------------------------------------------------------------
	// надо статусы из конфига подтянуть и показывать надпись соответствующую статусу
	if($StatusID == 'OnService')
		$StatusID = 'Suspended';
	#-------------------------------------------------------------------------------
	$Statuses = $Config['Statuses']['HostingOrders'];
	#-------------------------------------------------------------------------------
	if(!IsSet($Out['Last']))
		$Out['Last'] = Array();
	#-------------------------------------------------------------------------------
	Array_UnShift($Out['Last'],Array('Name'=>'Статус','Units'=>'','Limit'=>'','Used'=>$Statuses[$StatusID]['Name'],'Status'=>'Critical'));
//	$Out['Last']['LOCKED'] = Array('Name'=>'Статус','Units'=>'','Limit'=>'','Used'=>'Заблокирован','Status'=>'Critical');
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Out;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

