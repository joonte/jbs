<?php
#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Args');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// выбираем все активные заказы на лицензии - будем их использовать для определения,
// к каким заказам виртуальных/выделенных серверов не надо лицензию
// TODO посомтреть вариант убрать юезра из условия - может быть у друого юзера лицензия на этот IP
$Orders = Array();
#-------------------------------------------------------------------------------
$ISPswOrders = DB_Select('ISPswOrdersOwners',Array('ID','IP','StatusID'),Array('Where'=>Array(SPrintF('`UserID` = %u',$__USER['ID']),'`StatusID` = "Active"')));
#-------------------------------------------------------------------------------
switch(ValueOf($ISPswOrders)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	break;
case 'array':
	#-------------------------------------------------------------------------------
	foreach($ISPswOrders as $ISPswOrder)
		$Orders[] = $ISPswOrder['IP'];
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// список заказов к которым можно заказать лицензию
$DependOrders = Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// достаём заказы на ВПС для которых можно заказать лицензию
$Columns = Array('ID','Login','IP','OrderID','(SELECT `Address` FROM `Servers` WHERE `Servers`.`ID` = (SELECT `ServerID` FROM `OrdersOwners` WHERE `OrdersOwners`.`ID` = `VPSOrdersOwners`.`OrderID`)) AS `Address`');
#-------------------------------------------------------------------------------
$VPSOrders = DB_Select('VPSOrdersOwners',$Columns,Array('Where'=>SPrintF('`UserID` = %u AND `StatusID` = "Active"',$__USER['ID'])));
#-------------------------------------------------------------------------------
switch(ValueOf($VPSOrders)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	# No more...
	break;
case 'array':   
	#-------------------------------------------------------------------------------
	foreach($VPSOrders as $VPSOrder){
		#-------------------------------------------------------------------------------
		if(In_Array($VPSOrder['IP'],$Orders))
			continue;
		#-------------------------------------------------------------------------------
		$DependOrders[$VPSOrder['OrderID']] = SPrintF('VPS: %s / %s',$VPSOrder['IP'],$VPSOrder['Login']);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// достаём заказы на выделенные сервера
$Columns = Array('ID','IP','OrderID','(SELECT `Name` FROM `DSSchemes` WHERE `DSSchemes`.`ID` = `SchemeID`) as `Name`');
#-------------------------------------------------------------------------------
$DSOrders = DB_Select('DSOrdersOwners',$Columns,Array('Where'=>SPrintF('`UserID` = %u AND `StatusID` = "Active"',$__USER['ID'])));
#-------------------------------------------------------------------------------
switch(ValueOf($DSOrders)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	# No more...
	break;
case 'array':
	#-------------------------------------------------------------------------------
	foreach($DSOrders as $DSOrder){
		#-------------------------------------------------------------------------------
		if(In_Array($DSOrder['IP'],$Orders))
			continue;
		#-------------------------------------------------------------------------------
		$DependOrders[$DSOrder['OrderID']] = SPrintF('Сервер: %s / %s',$DSOrder['IP'],$DSOrder['Name']);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Out = Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Where = Array(
		'(`UserID` = @local.__USER_ID OR FIND_IN_SET(`GroupID`,@local.__USER_GROUPS_PATH))',
		'`IsActive` = "yes"',
		);
#-------------------------------------------------------------------------------
$ISPswSchemes = DB_Select('ISPswSchemesOwners','*',Array('Where'=>$Where,'SortOn'=>Array('SortID','PackageID')));
#-------------------------------------------------------------------------------
switch(ValueOf($ISPswSchemes)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return $Out;
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
// перебираем тарифы, к внутренним добавляем заказы
foreach($ISPswSchemes as $ISPswScheme){
	#-------------------------------------------------------------------------------
	$Out[$ISPswScheme['ID']] = $ISPswScheme;
	#-------------------------------------------------------------------------------
	if($ISPswScheme['IsInternal'])
		$Out[$ISPswScheme['ID']]['DependOrders'] = $DependOrders;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Out;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

