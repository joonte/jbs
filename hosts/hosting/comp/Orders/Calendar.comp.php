<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Args');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
// дата истечения оплаченого периода
$ExpirationDate	= (integer) @$Args['ExpirationDate'];
// минимальное время после оплаты
$sTime		= (integer) @$Args['sTime'];
// максимальное время после оплаты
$eTime		= (integer) @$Args['eTime'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Script = Array('var Calendar = [];','var Periods = [];');
#-------------------------------------------------------------------------------
$Years = $Periods = Array();
#-------------------------------------------------------------------------------
// пепебираем годы, от минмального года до максимального
for($Year=Date('Y',$sTime);$Year<=Date('Y',$eTime);$Year++){
	#-------------------------------------------------------------------------------
	$Months = Array();
	#-------------------------------------------------------------------------------
	$Script[] = SPrintF('Calendar[%u] = [];',$Year);
	#-------------------------------------------------------------------------------
	for($Month=1;$Month<13;$Month++){
		#-------------------------------------------------------------------------------
		$eDay = (integer)Date('t',MkTime(0,0,0,$Month,1,$Year));
		#-------------------------------------------------------------------------------
		for($Day=1;$Day<=$eDay;$Day++){
			#-------------------------------------------------------------------------------
			$CurrentStamp = MkTime(0,0,0,$Month,$Day,$Year);
			#-------------------------------------------------------------------------------
			if($CurrentStamp >= $sTime && $CurrentStamp <= $eTime){
				#-------------------------------------------------------------------------------
				$Script[] = SPrintF('Calendar[%u][%u] = {Start:%u,Stop:%u}',$Year,$Month-1,$Day,MkTime(0,0,0,$Month,$eDay,$Year) > $eTime?Date('j',$eTime):$eDay);
				#-------------------------------------------------------------------------------
				break;
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
		$CurrentStamp = MkTime(0,0,0,$Month,Min(Date('j',$ExpirationDate),Date('t',MkTime(0,0,0,$Month,1,$Year))),$Year);
		#-------------------------------------------------------------------------------
		if($CurrentStamp >= $sTime && $CurrentStamp <= $eTime){
			#-------------------------------------------------------------------------------
			$Period = (Date('n',$CurrentStamp) + Date('Y',$CurrentStamp)*12) - (Date('n',$ExpirationDate) + Date('Y',$ExpirationDate)*12);
			#-------------------------------------------------------------------------------
			if($Period < 4 || ($Period % 3 == 0 && $Period < 13) || $Period % 12 == 0){
				#-------------------------------------------------------------------------------
				// максимальное число дней в этом месяце этого года
				$DaysInMonth = $Month == 2 ? ($Year % 4 ? 28 : ($Year % 100 ? 29 : ($Year % 400 ? 28 : 29))) : (($Month - 1) % 7 % 2 ? 30 : 31);
				#-------------------------------------------------------------------------------
				// максимальный день при оплате - если он более числа дней в месяце, приравниваем к числу дней месяца
				$maxDay = ($DaysInMonth < Date('j',$ExpirationDate))?$DaysInMonth:Date('j',$ExpirationDate);
				$Script[] = SPrintF('Periods[%u] = {Year:%u,Month:%u,Day:%u}',$Period,$Year,$Month-1,$maxDay);
				#-------------------------------------------------------------------------------
				$Periods[$Period] = SPrintF('%u мес.',$Period);
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$Years[] = $Year;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Script'=>$Script,'Years'=>$Years,'Periods'=>$Periods);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
