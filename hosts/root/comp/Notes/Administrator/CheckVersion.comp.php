<?php

#-------------------------------------------------------------------------------
/** @author Vitaly Velikodny */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Result = Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$CacheID = Md5('CheckVersion');
#-------------------------------------------------------------------------------
$Out = CacheManager::get($CacheID);
#-------------------------------------------------------------------------------
if($Out)
	return $Out;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Interface']['Administrator']['Notes']['CheckVersion'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!$Settings['MakeCheckVersion'])
	return $Result;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$currentVersion = VERSION;
#-------------------------------------------------------------------------------
$opts = array('http'=>array('timeout'=>2));
$context  = stream_context_create($opts);
$versionInfoJson = @file_get_contents("http://joonte.com/public/version",false,$context);
#Debug(SprintF('[comp/Notes/Administrator/CheckVersion]: versionInfoJson = %s',$versionInfoJson));
#-------------------------------------------------------------------------------
$versionInfo = @json_decode($versionInfoJson, true);
#-------------------------------------------------------------------------------
if($versionInfoJson && $versionInfo){
	#-------------------------------------------------------------------------------
	if(!isset($versionInfo['version']))
		return $Result;
	#-------------------------------------------------------------------------------
	$LastVersion = $versionInfo['version'];
	#-------------------------------------------------------------------------------
	if($LastVersion != $currentVersion){
		#-------------------------------------------------------------------------------
		$NoBody = new Tag('NOBODY');
		$NoBody->AddHTML(TemplateReplace('Notes.Administrator.CheckVersion',Array('LastVersion'=>$LastVersion)));
		$Result[] = $NoBody;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
CacheManager::add($CacheID,$Result,600);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Result;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
