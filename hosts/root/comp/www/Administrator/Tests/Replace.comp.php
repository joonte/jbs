<?php


#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$Search  = (string) @$Args['Search'];
$Replace = (string) @$Args['Replace'];
#-------------------------------------------------------------------------------
$Regulars = Regulars();
#-------------------------------------------------------------------------------
#if(!Preg_Match($Regulars['Char'],$Search))
#  return ERROR | @Trigger_Error(201);
#-------------------------------------------------------------------------------
#if(!Preg_Match($Regulars['Char'],$Replace))
#  return ERROR | @Trigger_Error(201);
#-------------------------------------------------------------------------------
$Search  = "->Object";
$Replace = "->Object";
#-------------------------------------------------------------------------------
$Folder = (IsSet($Args['Folder'])?(string)$Args['Folder']:SYSTEM_PATH);
#-------------------------------------------------------------------------------
Header('Content-type: text/plain; charset=utf-8');
#-------------------------------------------------------------------------------
echo SPrintF("Scan folder %s\n",$Folder);
#-------------------------------------------------------------------------------
$Files = IO_Files($Folder);
if(Is_Error($Files))
  return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Count = Count($Files);
#-------------------------------------------------------------------------------
echo SPrintF("Finded %s files\n",$Count);
#-------------------------------------------------------------------------------
echo SPrintF("Search (%s) and replace on (%s)\n",$Search,$Replace);
#-------------------------------------------------------------------------------
$IsWrite = !IsSet($Args['NoWrite']);
#-------------------------------------------------------------------------------
$Count = 0;
#-------------------------------------------------------------------------------
foreach($Files as $File){
  #-----------------------------------------------------------------------------
  $Sourse = IO_Read($File);
  if(Is_Error($Sourse))
    return ERROR | @Trigger_Error(500);
  #-----------------------------------------------------------------------------
  //if(!Preg_Match('/\.comp.php/',$File))
  //  continue;
  #-----------------------------------------------------------------------------
  $Function = (IsSet($Args['RegEx'])?'Preg_Replace':'Str_Replace');
  #-----------------------------------------------------------------------------
  $Out = $Function($Search,$Replace,$Sourse);
  #-----------------------------------------------------------------------------
  if($Out != $Sourse){
    #---------------------------------------------------------------------------
    if($IsWrite){
      #-------------------------------------------------------------------------
      $IsWrite = IO_Write($File,$Out,TRUE);
      if(Is_Error($IsWrite))
        return ERROR | @Trigger_Error(500);
    }
    #---------------------------------------------------------------------------
    $Name = Mb_SubStr($File,Mb_StrLen($Folder) + 1);
    #---------------------------------------------------------------------------
    echo SPrintF("%s\n",$Name);
    #---------------------------------------------------------------------------
    $Count++;
  }
}
#-------------------------------------------------------------------------------
echo SPrintF("Replaced in %s files\n",$Count);
#-------------------------------------------------------------------------------


?>
