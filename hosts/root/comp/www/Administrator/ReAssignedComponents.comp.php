<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
if(Is_Error(System_Load('modules/Authorisation.mod','classes/DOM.class.php','libs/HTTP.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM = new DOM();
#-------------------------------------------------------------------------------
$Links = &Links();
# Коллекция ссылок
$Links['DOM'] = &$DOM;
#-------------------------------------------------------------------------------
if(Is_Error($DOM->Load('Base')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$DOM->AddAttribs('MenuLeft',Array('args'=>'Administrator/AddIns'));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$DOM->AddText('Title','Дополнения → Обслуживание → Перезаданные компоненты');
#-------------------------------------------------------------------------------
$NoBody = new Tag('NOBODY');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Files = Array();
#-------------------------------------------------------------------------------
// ищем все файлы
foreach(Array_Reverse($GLOBALS['HOST_CONF']['HostsIDs']) as $HostID){
	#-------------------------------------------------------------------------------
	$Prefix1 = SPrintF('%s/hosts/%s',SYSTEM_PATH,$HostID);
	#-------------------------------------------------------------------------------
	if(File_Exists($Prefix1)){
		#-------------------------------------------------------------------------------
		$Files1 = IO_Files($Prefix1);
		if(Is_Error($Files1))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		$Files1 = Array();
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Prefix2 = SPrintF('%s/styles/%s',SYSTEM_PATH,$HostID);
	#-------------------------------------------------------------------------------
	if(File_Exists($Prefix2)){
		#-------------------------------------------------------------------------------
		$Files2 = IO_Files($Prefix2);
		if(Is_Error($Files2))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		$Files2 = Array();
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$Files[$HostID] = Array_Merge($Files1,$Files2);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// убираем tmp и files из найденного в HOST_ID
	if($HostID == HOST_ID){
		#-------------------------------------------------------------------------------
		$Array = Array();
		#-------------------------------------------------------------------------------
		foreach($Files[$HostID] as $File)
			if(!Preg_Match(SPrintF('#%s/tmp/#',$Prefix1),$File))
				if(!Preg_Match(SPrintF('#%s/files/#',$Prefix1),$File))
					$Array[] = $File;
		#-------------------------------------------------------------------------------
		$Files[$HostID] = $Array;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// выпиливаем начальную часть пути у найденных файлов
	$Files[$HostID] = Preg_Replace(SPrintF('#%s/#',$Prefix1),'',$Files[$HostID]);
	$Files[$HostID] = Preg_Replace(SPrintF('#%s/#',$Prefix2),'',$Files[$HostID]);
	#-------------------------------------------------------------------------------
}

#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// перебираем найденные в HOST_ID файлы, проверяем совпадения
$Out = Array('Merge'=>Array(),'Replace'=>Array(),'Uniq'=>Array());
$Table = Array('Используется последний файл');
#-------------------------------------------------------------------------------
foreach($Files[HOST_ID] as $File){
	#-------------------------------------------------------------------------------
	$IsFound = FALSE;
	#-------------------------------------------------------------------------------
	$Array = Array();
	#-------------------------------------------------------------------------------
	foreach(Array_Reverse($GLOBALS['HOST_CONF']['HostsIDs']) as $HostID){
		#-------------------------------------------------------------------------------
		if($HostID == HOST_ID)
			continue;
		#-------------------------------------------------------------------------------
		if(In_Array($File,$Files[$HostID])){
			#-------------------------------------------------------------------------------
			$Array[] = Array($HostID,$File);
			#-------------------------------------------------------------------------------
			$IsFound = TRUE;
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	if($IsFound){
		#-------------------------------------------------------------------------------
		$Array[] = Array(HOST_ID,$File);
		#-------------------------------------------------------------------------------
		// достаём расширение файла
		$Array1 = Explode('.',$File);
		#-------------------------------------------------------------------------------
		if($Array1[(Count($Array1)-1)] == 'xml'){
			#-------------------------------------------------------------------------------
			$Out['Merge'][] = $Array;
			#-------------------------------------------------------------------------------
		}else{
			#-------------------------------------------------------------------------------
			$Out['Replace'][] = $Array;
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		$Out['Uniq'][] = Array(HOST_ID,$File);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Table = Array();
#-------------------------------------------------------------------------------
// перебираем полученный массив файлов $Out, строим таблицу
foreach(Array_Keys($Out) as $Type){
	#-------------------------------------------------------------------------------
	if(SizeOf($Out[$Type])){
		#-------------------------------------------------------------------------------
		// шапочки
		if($Type == 'Uniq'){
			#-------------------------------------------------------------------------------
			$Table[] = 'Файл отсутствует в дистрибутиве';
			#-------------------------------------------------------------------------------
		}elseif($Type == 'Replace'){
			#-------------------------------------------------------------------------------
			$Table[] = 'Файл заменяет дистрибутивный';
			#-------------------------------------------------------------------------------
		}else{
			#-------------------------------------------------------------------------------
			$Table[] = 'Используется слияние файлов';
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		foreach($Out[$Type] as $Info){
			#-------------------------------------------------------------------------------
			// найденные файлы
			if($Type == 'Uniq'){
				#-------------------------------------------------------------------------------
				$Table[] = $Info;
				#-------------------------------------------------------------------------------
			}else{
				#-------------------------------------------------------------------------------
				foreach($Info as $i)
					$Table[] = $i;
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
			$Table[] = ' ';
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(SizeOf($Table) > 0){
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load('Tables/Standard',$Table,Array('width'=>'100%'));
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$NoBody->AddChild($Comp);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$DOM->AddChild('Into',$NoBody);
#-------------------------------------------------------------------------------
$Out = $DOM->Build();
#-------------------------------------------------------------------------------
if(Is_Error($Out))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Out;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
