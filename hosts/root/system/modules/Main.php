<?php
#-------------------------------------------------------------------------------
/** @author Бреславский А.В. (Joonte Ltd.) */
#-------------------------------------------------------------------------------
$__URI = $GLOBALS['__URI'];
#-------------------------------------------------------------------------------
$IsElement = System_Element(SPrintF('comp/www%s.comp.php',$__URI));
#-------------------------------------------------------------------------------
if(Is_Error($IsElement)){
  #-----------------------------------------------------------------------------
  $__URI = &$GLOBALS['__URI'];
  #-----------------------------------------------------------------------------
  $__URI = '/404';
}
#-------------------------------------------------------------------------------
$Result = Comp_Load(SPrintF('www%s',$__URI));
#-------------------------------------------------------------------------------
switch(ValueOf($Result)){
  case 'error':
    return ERROR | @Trigger_Error('[system/modules/Main]: не удалось загрузить основной компонент системы');
  case 'exception':
    #---------------------------------------------------------------------------
    $Answer = Array('Exception'=>$Result,'Status'=>'Exception');
    #---------------------------------------------------------------------------
    echo JSON_Encode($Answer);
  break;
  case 'false':
    echo JSON_Encode(Array('Status'=>'FALSE'));
  break;
  case 'true':
    echo JSON_Encode(Array('Status'=>'TRUE'));
  break;
  case 'array':
    $Result = JSON_Encode($Result);
  case 'string':
    #---------------------------------------------------------------------------
    if(!Headers_Sent()){
      #-------------------------------------------------------------------------
      List($Micro,$Seconds) = Explode(' ',MicroTime());
      #-------------------------------------------------------------------------
      Header(SPrintF('Waiting-Time: %01.2f sec',((float)$Micro + (float)$Seconds) - START_TIME));
      #-------------------------------------------------------------------------
      $Size = MB_StrLen($Result,'ASCII');
      #-------------------------------------------------------------------------
      if($Size > 30720 && Preg_Match('/gzip/',(string)@$_SERVER['HTTP_ACCEPT_ENCODING'])){
        #-----------------------------------------------------------------------
        Header(SPrintF('Real-Content-Length: %u',$Size));
        #-----------------------------------------------------------------------
        $Result = GzEncode($Result);
        #-----------------------------------------------------------------------
        Header('Content-Encoding: gzip');
        Header(SPrintF('Content-Length: %u',MB_StrLen($Result,'ASCII')));
      }
    }
    #---------------------------------------------------------------------------
    echo $Result;
  break;
  default:
    # No more...
}
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------
?>
