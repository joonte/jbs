<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Invoice');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Comp = Comp_Load('Invoices/Build',$Invoice['ID']);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$YandexMetrika = $Config['Invoices']['YandexMetrika'];
#-------------------------------------------------------------------------------
// если метрика НЕ включена, то всё
if(!$YandexMetrika['IsActive'] || !$YandexMetrika['YandexCounterId'] || !$YandexMetrika['Token'])
	return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// библиотека для работы с ХТТП
if(Is_Error(System_Load('libs/HTTP.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$HTTP = Array(
		'Address'	=> 'api-metrika.yandex.net',
		'Port'		=> 443,
		'Host'		=> 'api-metrika.yandex.net',
		'Protocol'	=> 'ssl',
		'Charset'	=> 'UTF-8',
		'IsLogging'	=> FALSE
		);
#-------------------------------------------------------------------------------
$Query = Array('orders' => Array());
#-------------------------------------------------------------------------------
$Query['orders'][] = Array(
				'id'			=> $Invoice['ID'],
				'client_uniq_id'	=> $Invoice['UserID'],
				'client_type'		=> 'CONTACT',
				'create_date_time'	=> SPrintF('%s %s',Date('Y-m-d',$Invoice['CreateDate']),Date('G:i:s',$Invoice['CreateDate'])),
				'order_status'		=> 'IN_PROGRESS',
				'revenue'		=> $Invoice['Summ']
				);
#-------------------------------------------------------------------------------
$URL = SPrintF('/cdp/api/v1/counter/%s/data/orders?merge_mode=SAVE',$YandexMetrika['YandexCounterId']);
#-------------------------------------------------------------------------------
// заголовки
$Headers = Array(SPrintF('Authorization: OAuth %s',$YandexMetrika['Token']),'Content-Type: application/json');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// на результат пофигу
$Result = @HTTP_Send($URL,$HTTP,Array(),Json_Encode($Query),$Headers);
#-------------------------------------------------------------------------------
$Result = Trim($Result['Body']);
#-------------------------------------------------------------------------------
$Result = Json_Decode($Result,TRUE);
#-------------------------------------------------------------------------------
Debug('[Triggers/Statuses/Invoices/Waiting]: Result = %s',print_r($Result,true));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
