<?php
#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('LinkID');
/******************************************************************************/
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Links = &Links();
# Коллекция ссылок
$Template = &$Links[$LinkID];
/******************************************************************************/
/******************************************************************************/
$Table = new Tag('TABLE',Array('class'=>'TableSuperData','cellspacing'=>0));
#-------------------------------------------------------------------------------
# Последовательность вывода
$Sequence = $Template['Sequence'];
# Шапка таблицы
$Columns = $Template['Columns'];
# Источник данных
$Source = $Template['Source'];
# Внешнее оформление
$Appearance = $Template['Appearance'];
#-------------------------------------------------------------------------------
if($IsHead = $Appearance['IsHead']){
  #-----------------------------------------------------------------------------
  $Tr = new Tag('TR');
  #-----------------------------------------------------------------------------
  foreach($Sequence as $ColumnID){
    #---------------------------------------------------------------------------
    $Column = $Columns[$ColumnID];
    #---------------------------------------------------------------------------
    if(IsSet($Column['Hidden']))
      continue;
    #---------------------------------------------------------------------------
    $Head = ($Column['Head']?$Column['Head']:'-');
    #---------------------------------------------------------------------------
    $Td = new Tag('TH',Array('class'=>'TableSuperHeadUnActive'));
    #---------------------------------------------------------------------------
    if(Is_Array($Head)){
      #-------------------------------------------------------------------------
      $Args = $Head['Args'];
      #-------------------------------------------------------------------------
      Array_UnShift($Args,$Head['Comp']);
      #-------------------------------------------------------------------------
      $Comp = Call_User_Func_Array('Comp_Load',$Args);
      if(Is_Error($Comp))
        return ERROR | @Trigger_Error(500);
      #-------------------------------------------------------------------------
      $Td->AddChild($Comp);
    }else{
      #-------------------------------------------------------------------------
      if($Appearance['IsSorted'] && $Column['IsSorted'] && $Source['Count'] > 1){
        #-----------------------------------------------------------------------
        $Query = $Template['Query'];
        #-----------------------------------------------------------------------
        $IsSorted = $Query['SortOn'] == $ColumnID;
        #-----------------------------------------------------------------------
        $IsDesc = (integer)!$Query['IsDesc'];
        #-----------------------------------------------------------------------
        $Td->AddAttribs(Array('class'=>'TableSuperHeadActive','onclick'=>SPrintF("TableSuperSort('%s',%u);",$ColumnID,$IsDesc)),TRUE);
        #-----------------------------------------------------------------------
        if($IsSorted){
          #---------------------------------------------------------------------
          $Td->AddAttribs(Array('class'=>'TableSuperHeadOrdered'),TRUE);
          #---------------------------------------------------------------------
          $Image = ($IsDesc?1:2);
          #---------------------------------------------------------------------
          $Img = new Tag('IMG',Array('alt'=>'-','height'=>15,'src'=>SPrintF('SRC:{Images/TableSuperSort%s.png}',$Image),'width'=>10));
          #---------------------------------------------------------------------
          $Td->AddChild($Img);
        }
      };
      #-------------------------------------------------------------------------
      $Td->AddChild(new Tag('SPAN',$Head));
      #-------------------------------------------------------------------------
      if(IsSet($Column['Prompt'])){
        #-----------------------------------------------------------------------
        $LinkID = UniqID('Head');
        #-----------------------------------------------------------------------
        $Links = &Links();
        #-----------------------------------------------------------------------
        $Links[$LinkID] = &$Td;
        #-----------------------------------------------------------------------
        $Comp = Comp_Load('Form/Prompt',$LinkID,$Column['Prompt']);
        if(Is_Error($Comp))
          return ERROR | @Trigger_Error(500);
        #-----------------------------------------------------------------------
        UnSet($Links[$LinkID]);
        #-----------------------------------------------------------------------
        $Td->AddChild(new Tag('SPAN',Array('style'=>'font-weight:bold;font-size:14px;'),'?'));
      }
    }
    #---------------------------------------------------------------------------
    $Tr->AddChild($Td);
  }
  $Th = new Tag('THEAD');
  #-------------------------------------------------------------------------------
  $Th->AddChild($Tr);
  #-----------------------------------------------------------------------------
  $Table->AddChild($Th);
}
#-------------------------------------------------------------------------------
$Data = $Source['Data'];
#-------------------------------------------------------------------------------
if(!Count($Data)){
  #-----------------------------------------------------------------------------
  $Message = ($Source[$Source['Conditions']['Count'] < 1?'Conditions':'Adding']['Message']);
  #-----------------------------------------------------------------------------
  if(!$IsHead){
    #---------------------------------------------------------------------------
    $Comp = Comp_Load('Information',$Message,'Notice');
    if(Is_Error($Comp))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    return $Comp;
  }
  #-----------------------------------------------------------------------------
  $Table->AddChild(new Tag('TR',new Tag('TD',Array('colspan'=>Count($Sequence),'class'=>'TableSuperNoData'),$Message)));
  #-----------------------------------------------------------------------------
  return $Table;
}
#-------------------------------------------------------------------------------
if(!Function_Exists('Table_Super_Replace')){
  #-----------------------------------------------------------------------------
  function Table_Super_Replace($Array,$Matches){
    #---------------------------------------------------------------------------
    $Result = Array();
    #---------------------------------------------------------------------------
    if(Is_Array($Array)){
      #-------------------------------------------------------------------------
      foreach(Array_Keys($Array) as $ElementID){
        #-----------------------------------------------------------------------
        $Element = $Array[$ElementID];
        #-----------------------------------------------------------------------
        $Result[$ElementID] = (Is_Array($Element)?Table_Super_Replace($Element,$Matches):Str_Replace(Array_Keys($Matches),Array_Values($Matches),$Element));
      }
    }
    #---------------------------------------------------------------------------
    return $Result;
  }
}
#-------------------------------------------------------------------------------
foreach($Data as $Row){
  #-----------------------------------------------------------------------------
  $Replace = Array_ToLine($Row,'%');
  #-----------------------------------------------------------------------------
  $Tr = new Tag('TR');
  #-----------------------------------------------------------------------------
  if(StrLen($Comp = $Appearance['Row']['Comp'])){
    #---------------------------------------------------------------------------
    $Args = Table_Super_Replace($Appearance['Row']['Args'],$Replace);
    #---------------------------------------------------------------------------
    Array_UnShift($Args,$Comp);
    #---------------------------------------------------------------------------
    $Comp = Call_User_Func_Array('Comp_Load',$Args);
    if(Is_Error($Comp))
      return ERROR | @Trigger_Error(500);
    #---------------------------------------------------------------------------
    $Tr->AddAttribs($Comp);
  }
  #-----------------------------------------------------------------------------
  foreach($Sequence as $ColumnID){
    #---------------------------------------------------------------------------
    $Column = $Columns[$ColumnID];
    #---------------------------------------------------------------------------
    if(IsSet($Column['Hidden']))
      continue;
    #---------------------------------------------------------------------------
    $Td = new Tag('TD',Array('data-label'=>IsSet($Column['LongName'])?$Column['LongName']:$ColumnID));
    #---------------------------------------------------------------------------
    $Value = (IsSet($Row[$ColumnID])?$Row[$ColumnID]:'');
    #---------------------------------------------------------------------------
    if(StrLen($Comp = $Column['Comp'])){
      #-------------------------------------------------------------------------
      $Args = Table_Super_Replace($Column['Args'],$Replace);
      #-------------------------------------------------------------------------
      Array_UnShift($Args,$Comp);
      #-------------------------------------------------------------------------
      $Value = Call_User_Func_Array('Comp_Load',$Args);
      if(Is_Error($Value))
        return ERROR | @Trigger_Error('[comp/Tables/Super]: не удалось отформатировать значение');
    }
    #---------------------------------------------------------------------------
    switch(ValueOf($Value)){
      case 'object':
        $Td->AddChild($Value);
      break;
      default:
        $Td->AddText($Value);
    }
    #---------------------------------------------------------------------------
    $Attribs = $Column['Attribs'];
    #---------------------------------------------------------------------------
    if(Is_Array($Attribs))
      $Td->AddAttribs($Attribs);
    #---------------------------------------------------------------------------
    $Tr->AddChild($Td);
  }
  #-----------------------------------------------------------------------------
  $Table->AddChild($Tr);
}
#-------------------------------------------------------------------------------
return $Table;
#-------------------------------------------------------------------------------

?>
