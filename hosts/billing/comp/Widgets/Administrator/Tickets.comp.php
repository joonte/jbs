<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
#$Tickets = DB_Select('Edesks',Array('COUNT(*) as `Count`','StatusID'),Array('Where'=>Array("(SELECT `IsDepartment` FROM `Groups` WHERE `Groups`.`ID` = `Edesks`.`TargetGroupID`) = 'yes'","(SELECT `IsDepartment` FROM `Groups` WHERE `Groups`.`ID` = (SELECT `GroupID` FROM `Users` WHERE `Users`.`ID` = `Edesks`.`UserID`)) = 'no'"),'GroupBy'=>'StatusID'));
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Tickets = DB_Select('Edesks',Array('COUNT(*) as `Count`','StatusID'),Array('GroupBy'=>'StatusID'));
#-------------------------------------------------------------------------------
switch(ValueOf($Tickets)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	break;
case 'array':
	#-------------------------------------------------------------------------------
	$Statuses = $Config['Statuses']['Edesks'];
	#-------------------------------------------------------------------------------
	$Table = Array('Поддержка, статусы');
	#-------------------------------------------------------------------------------
	foreach(Array_Keys($Statuses) as $StatusID){
		#-------------------------------------------------------------------------------
		$Status = $Statuses[$StatusID];
		#-------------------------------------------------------------------------------
		foreach($Tickets as $Ticket){
			#-------------------------------------------------------------------------------
			if($Ticket['StatusID'] != $StatusID)
				continue;
			#-------------------------------------------------------------------------------
			$Table[] = Array(new Tag('A',Array('href'=>SPrintF('/Administrator/Tickets?PatternOutID=%s',$StatusID)),$Status['Name']),(integer)$Ticket['Count']);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Tickets = DB_Select('Edesks',Array('COUNT(*) as `Count`','Flags'),Array('GroupBy'=>'Flags'));
#-------------------------------------------------------------------------------
switch(ValueOf($Tickets)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	break;
case 'array':
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(IsSet($Table)){
		#-------------------------------------------------------------------------------
		$Table[] = 'Поддержка, флаги';
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		$Table = Array('Поддержка, флаги');
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Flags = $Config['Edesks']['Flags'];
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	foreach(Array_Keys($Flags) as $Key){
		#-------------------------------------------------------------------------------
		foreach($Tickets as $Ticket){
			#-------------------------------------------------------------------------------
			if($Ticket['Flags'] != $Key)
				continue;
			#-------------------------------------------------------------------------------
			$Table[] = Array($Flags[$Key],(integer)$Ticket['Count']);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(!IsSet($Table))
	return FALSE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Tables/Standard',$Table);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Title'=>'Статусы запросов','DOM'=>$Comp);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
