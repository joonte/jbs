<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda (for www.host-food.ru) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('PaymentSystemID','InvoiceID','Summ');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Invoices']['PaymentSystems']['W1'];
#-------------------------------------------------------------------------------
$Send = $Settings['Send'];
#-------------------------------------------------------------------------------
# нули после точки - обязательны
$Send['WMI_PAYMENT_AMOUNT'] = Number_Format($Summ/$Settings['Course'], 2, '.', '');
#$Send['WMI_PAYMENT_AMOUNT'] = Round($Summ/$Settings['Course'],2);
#-------------------------------------------------------------------------------
$Send['WMI_PAYMENT_NO'] = $InvoiceID;
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Formats/Invoice/Number',$InvoiceID);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
$Send['WMI_DESCRIPTION'] .= SPrintF('%s, %s (%s)',$Comp,Translit($__USER['Name']),$__USER['Email']);
#-------------------------------------------------------------------------------
$Send['WMI_SUCCESS_URL'] = SPrintF('%s://%s/Invoices',Url_Scheme(),HOST_ID);
$Send['WMI_FAIL_URL']    = SPrintF('%s://%s/Invoices?Error=yes',Url_Scheme(),HOST_ID);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# а ещё в люобй форме есть CSRF
$Send['CSRF'] = $GLOBALS['CSRF'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
//Сортировка значений внутри полей
foreach($Send as $name => $val){
	#-------------------------------------------------------------------------------
	if(Is_Array($val)){
		#-------------------------------------------------------------------------------
		USort($val,"strcasecmp");
		#-------------------------------------------------------------------------------
		$Send[$name] = $val;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// Формирование сообщения, путем объединения значений формы, 
// отсортированных по именам ключей в порядке возрастания.
UkSort($Send, "strcasecmp");
#-------------------------------------------------------------------------------
$Hash = "";
#-------------------------------------------------------------------------------
foreach($Send as $value){
	#-------------------------------------------------------------------------------
	if(is_array($value)){
		#-------------------------------------------------------------------------------
		foreach($value as $v){
			#-------------------------------------------------------------------------------
			//Конвертация из текущей кодировки (UTF-8)
			//необходима только если кодировка магазина отлична от Windows-1251
			$v = Iconv("utf-8", "windows-1251", $v);
			#-------------------------------------------------------------------------------
			$Hash .= $v;
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		//Конвертация из текущей кодировки (UTF-8)
		//необходима только если кодировка магазина отлична от Windows-1251
		$value = Iconv("utf-8", "windows-1251", $value);
		#-------------------------------------------------------------------------------
		$Hash .= $value;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
// Формирование значения параметра WMI_SIGNATURE, путем 
// вычисления отпечатка, сформированного выше сообщения, 
// по алгоритму MD5 и представление его в Base64
Debug(SPrintF('[comp/Invoices/PaymentSystems/W1]: Hash = %s',$Hash));
#-------------------------------------------------------------------------------
$Send['WMI_SIGNATURE'] = Base64_Encode(Pack("H*",sha1($Hash . $Settings['Hash'])));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# так как CSRF уже есть, удаляем её из списка полей, иначе задублируется
UnSet($Send['CSRF']);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Send;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
