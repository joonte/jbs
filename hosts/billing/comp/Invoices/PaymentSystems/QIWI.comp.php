<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('SystemID','InvoiceID','Summ');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Invoices']['PaymentSystems']['QIWI'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Send = $Settings['Send'];
#-------------------------------------------------------------------------------
$Send['txn_id'] = $InvoiceID;
#-------------------------------------------------------------------------------
$Send['summ'] = Round($Summ/$Settings['Course'],2);
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Formats/Invoice/Number',$InvoiceID);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
$Send['com'] .= SPrintF('%s, %s (%s)',$Comp,Translit($__USER['Name']),$__USER['Email']);
$Send['com'] = URLEncode(Str_Replace('#','',$Send['com']));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# выбираем телефон юзера, первый из списка
$Address = '';
#-------------------------------------------------------------------------------
foreach($__USER['Contacts'] as $Contact)
	if($Contact['MethodID'] == 'SMS')
		$Address = $Contact['Address'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Send['to'] = SPrintF('+%s',$Address);
#-------------------------------------------------------------------------------
$Send['currency'] = $Settings['Valute'];
#-------------------------------------------------------------------------------
$Send['successUrl'] = SPrintF('%s://%s/Invoices',URL_SCHEME,HOST_ID);
$Send['failUrl']    = SPrintF('%s://%s/Invoices?Error=yes',URL_SCHEME,HOST_ID);
#-------------------------------------------------------------------------------
Debug(SPrintF('[comp/Invoices/PaymentSystems/QIWI]: to = %s',$Send['to']));
#-------------------------------------------------------------------------------
return $Send;
#-------------------------------------------------------------------------------

?>
