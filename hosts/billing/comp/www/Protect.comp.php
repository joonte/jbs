<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
#-------------------------------------------------------------------------------
$Codes = System_XML('tmp/protect.xml');
if(Is_Error($Codes))
	$Codes = Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// генерируем
$Codes[UniqID('ID')] = Array('IP'=>$_SERVER['REMOTE_ADDR'],'Secret'=>$Secret = Rand(100000,900000),'Date'=>Time());
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$XML = To_XML_String($Codes);
if(Is_Error($XML))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IsWrite = IO_Write(SPrintF('%s/protect.xml',$Tmp),$XML,TRUE);
if(Is_Error($IsWrite))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Path = Styles_Element('Images/ProtectBg.png');
if(Is_Error($Path))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Im = ImageCreateFromPng($Path);
#-------------------------------------------------------------------------------
$Color = ImageColorAllocate($Im,0,0,0);
#-------------------------------------------------------------------------------
$Px = IntVal((ImageSx($Im) - 8.5 * StrLen($Secret))/2);
#-------------------------------------------------------------------------------
ImageString($Im,5,$Px,9,$Secret,$Color);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
Header('Content-Type: image/png');
ImagePng($Im);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
