<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Password	= (string) @$Args['Password'];
$UserID		= (integer)@$Args['UserID'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($UserID && !$GLOBALS['__USER']['IsAdmin'])
	return ERROR | @Trigger_Error(700);
#-------------------------------------------------------------------------------
// создаём переменную, надо ли отрабатывать процедуру перелогина - на случай если админ юзеру пас меняет
$Logon = ($UserID)?FALSE:TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Regulars = Regulars();
#-------------------------------------------------------------------------------
if(!Preg_Match($Regulars['Password'],$Password))
	return new gException('WRONG_PASSWORD','Неверно указан новый пароль');
#-------------------------------------------------------------------------------
$IsCheck = Comp_Load('Passwords/Checker',$Password,'Change');
if(Is_Error($IsCheck))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
if(Is_Exception($IsCheck))
	return $IsCheck;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$User = DB_Select('Users',Array('ID','Email'),Array('UNIQ','ID'=>(($UserID)?$UserID:$GLOBALS['__USER']['ID'])));
#-------------------------------------------------------------------------------
switch(ValueOf($User)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
$UserID = (integer)$User['ID'];
#-------------------------------------------------------------------------------
$IsUpdate = DB_Update('Users',Array('Watchword'=>Md5($Password),'UniqID'=>Md5(SPrintF('%s.%s,',UniqID(),Rand(0,1000000)))),Array('ID'=>$UserID));
if(Is_Error($IsUpdate))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Path = SPrintF('%s/sessions',$Tmp);
#-------------------------------------------------------------------------------
if(File_Exists($Path)){
	#-------------------------------------------------------------------------------
	$SessionIDs = IO_Scan($Path);
	if(Is_Error($SessionIDs))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	foreach($SessionIDs as $SessionID){
		#-------------------------------------------------------------------------------
		if(Preg_Match(SPrintF('/^(REMEBMER|SESSION)%s/',MD5($UserID)),$SessionID)){
			#-------------------------------------------------------------------------------
			if(!@UnLink(SPrintF('%s/%s',$Path,$SessionID)))
				return ERROR | @Trigger_Error(500);
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// если это админ меняет пасс юзеру - перелогиниватсья ненадо
if(!$Logon)
	return Array('Status'=>'Ok');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Logon = Comp_Load('www/API/Logon',Array('Email'=>(string)$User['Email'],'Password'=>(string)$Password,'IsRemember'=>TRUE));
#-------------------------------------------------------------------------------
switch(ValueOf($Logon)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	#-------------------------------------------------------------------------------
	$Comp = Comp_Load('www/Logon',$Logon);
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	Exit(Is_Array($Comp)?JSON_Encode($Comp):$Comp);
	#-------------------------------------------------------------------------------
case 'array':
	#-------------------------------------------------------------------------------
	// логгируем IP
	$Comp = Comp_Load('Users/LogIP',$GLOBALS['__USER']['ID'],IsSet($GLOBALS['_SERVER']['REMOTE_ADDR'])?$GLOBALS['_SERVER']['REMOTE_ADDR']:'127.0.0.123',IsSet($GLOBALS['_SERVER']['HTTP_USER_AGENT'])?$GLOBALS['_SERVER']['HTTP_USER_AGENT']:'');
	if(Is_Error($Comp))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$IsUpdated = DB_Update('Users',Array('EnterDate'=>Time(),'EnterIP'=>$_SERVER['REMOTE_ADDR']),Array('ID'=>$GLOBALS['__USER']['ID']));
	if(Is_Error($IsUpdated))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Array('Status'=>'Ok','Message'=>'Пароль успешно изменён');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
