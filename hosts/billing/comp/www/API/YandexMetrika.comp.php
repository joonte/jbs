<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = Args();
#-------------------------------------------------------------------------------
$clientID = (integer) @$Args['clientID'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// включено ли вообще
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Interface']['User']['YandexMetrika'];
#-------------------------------------------------------------------------------
if(!$Settings['IsActive'])
	return Array('Status'=>'Ok','IsActive'=>FALSE);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// вариант 1: прислан ClientID, сохраняем его
if($clientID){
	#-------------------------------------------------------------------------------
	// может быть не авторизован
	if(!IsSet($GLOBALS['__USER']['ID']))
		return Array('Status'=>'Ok','UnAuthorised'=>TRUE);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(IsSet($GLOBALS['__USER']['IsEmulate']) && $GLOBALS['__USER']['IsEmulate']){
		#-------------------------------------------------------------------------------
		Debug(SPrintF('[comp/www/API/YandexMetrika]: это эмуляция, clientID не логгируется'));
		#-------------------------------------------------------------------------------
		return Array('Status'=>'Ok','IsEmulate'=>TRUE);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	if(!In_Array($clientID,$GLOBALS['__USER']['Params']['YM'])){
		#-------------------------------------------------------------------------------
		// сохраняем присланный иденфтикатор метрики
		$GLOBALS['__USER']['Params']['YM'][] = $clientID;
		#-------------------------------------------------------------------------------
		$IsUpdate = DB_Update('Users',Array('Params'=>$GLOBALS['__USER']['Params']),Array('ID'=>$GLOBALS['__USER']['ID']));
		if(Is_Error($IsUpdate))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		// сохраяем юзера во временную таблицу, у кого надо контакты в метрике обновлять
		$IsInsert = DB_Insert('TmpData',Array('UserID'=>$GLOBALS['__USER']['ID'],'AppID'=>'YandexMetrika','Col1'=>'Contacts','Col2'=>$GLOBALS['__USER']['Email']));
		if(Is_Error($IsInsert))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		if(SizeOf($GLOBALS['__USER']['Params']['YM']) > 1)
			Debug(SPrintF('[comp/www/API/YandexMetrika]: new SizeOf(YM) = %s',SizeOf($GLOBALS['__USER']['Params']['YM'])));
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		if(SizeOf($GLOBALS['__USER']['Params']['YM']) > 1)
			Debug(SPrintF('[comp/www/API/YandexMetrika]: SizeOf(YM) = %s',SizeOf($GLOBALS['__USER']['Params']['YM'])));
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	return Array('Status'=>'Ok');
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// вариант 2: НЕ прислан ClientID, отдаём скрипт счётчика
if(!$Settings['YandexCounterId'])
	return Array('Status'=>'Ok','YandexCounterId'=>FALSE);
#-------------------------------------------------------------------------------
if(!$Settings['Token'])
	return Array('Status'=>'Ok','Token'=>FALSE);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TemplateReplace('YandexMetrika',Array('YandexCounterId'=>$Settings['YandexCounterId']),FALSE);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
