<?php
#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Args');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
$UserID	=  (integer) @$Args['UserID'];
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','libs/Upload.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Out = Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Users = DB_Select('Users',Array('ID','GroupID','RegisterDate','Name','Email','Sign','EnterIP','EnterDate','IsActive','IsNotifies','Params','IsConfirmed'),Array('ID'=>($UserID > 0)?$UserID:$GLOBALS['__USER']['ID']));
#-------------------------------------------------------------------------------
switch(ValueOf($Users)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return $Out;
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
foreach($Users as $User){
	#-------------------------------------------------------------------------------
	// если это запрос чужих данных, то пока тока один вариат - были тикеты с участием этого человека. проверяем
	if($UserID > 0 && $UserID != $GLOBALS['__USER']['ID']){
		#-------------------------------------------------------------------------------
		// есть ли тикеты владелец которых авторизованный юзер и в нём участвует запрошенный в UserID пользователь
		$Count = DB_Count('EdesksMessagesOwners',Array('Where'=>Array(SPrintF('`EdeskID` IN (SELECT `ID` FROM `EdesksOwners` WHERE `UserID` = %u)',$GLOBALS['__USER']['ID']),SPrintF('`UserID` = %u',$UserID))));
		if(Is_Error($Count))
			return ERROR | @Trigger_Error(500);
		#-------------------------------------------------------------------------------
		if(!$Count)
			continue;
		#-------------------------------------------------------------------------------
		// выпиливаем лишнее
		UnSet($User['RegisterDate']);
		UnSet($User['Email']);
		UnSet($User['EnterIP']);
		UnSet($User['EnterDate']);
		UnSet($User['IsActive']);
		UnSet($User['IsNotifies']);
		UnSet($User['Params']);
		UnSet($User['IsConfirmed']);
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		// это запрос своих даных. надо докинуть контакты
		$iContacts = DB_Select('Contacts',Array('*'),Array('Where'=>SPrintF('`UserID` = %u',$GLOBALS['__USER']['ID'])));
		#-------------------------------------------------------------------------------
		switch(ValueOf($iContacts)){
		case 'error':
			return ERROR | @Trigger_Error(500);
		case 'exception':
			return $Out;
		case 'array':
			break;
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
		$Contacts = Array();
		#-------------------------------------------------------------------------------
		foreach($iContacts as $Contact){
			#-------------------------------------------------------------------------------
			// код подтверждения показывать не надо
			UnSet($Contact['Confirmation']);
			#-------------------------------------------------------------------------------
			$Contacts[$Contact['ID']] = $Contact;
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$Out[$User['ID']] = $User;
	#-------------------------------------------------------------------------------
	if(IsSet($Contacts))
		$Out[$User['ID']]['Contacts'] = $Contacts;
	// докУменты
	$Files = GetUploadedFilesInfo('Users',$User['ID']);
	#-------------------------------------------------------------------------------
	if(SizeOf($Files)){
		#-------------------------------------------------------------------------------
		$Out[$User['ID']]['Files'] = Array();
		#-------------------------------------------------------------------------------
		foreach($Files as $File)
			$Out[$User['ID']]['Files'][$File['ID']] = $File;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	UnSet($Contacts);
	UnSet($iContacts);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// переключение юзера в другого
if(!$UserID){
	#-------------------------------------------------------------------------------
	$Session = new Session((string)@$_COOKIE['SessionID']);
	#-------------------------------------------------------------------------------
	$IsLoad = $Session->Load();
	if(Is_Error($IsLoad))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$UsersIDs = @$Session->Data['UsersIDs'];
	#-------------------------------------------------------------------------------
	if(Count($UsersIDs) < 1)
		return ERROR | @Trigger_Error(400);
	#-------------------------------------------------------------------------------
	$Array = Array();
	#-------------------------------------------------------------------------------
	foreach($UsersIDs as $UserID)
		$Array[] = (integer)$UserID;
	#-------------------------------------------------------------------------------
	$Users = DB_Select('Users',Array('ID','Name','Email'),Array('Where'=>SPrintF('`ID` IN (%s)',Implode(',',$Array))));
	#-------------------------------------------------------------------------------
	switch(ValueOf($Users)){
	case 'error':
		return ERROR | @Trigger_Error(500);
	case 'exception':
		return ERROR | @Trigger_Error(400);
	case 'array':
		break;
	default:
		return ERROR | @Trigger_Error(101);
	}
	#-------------------------------------------------------------------------------
	if(Count($Users) > 1)
		foreach($Users as $User)
			if($User['ID'] != $GLOBALS['__USER']['ID'])
				if($UserID != $GLOBALS['__USER']['ID'])
					$Out[$GLOBALS['__USER']['ID']]['UserSwitch'][$User['ID']] = $User;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Out;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
