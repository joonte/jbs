<?php
#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Args');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Args = IsSet($Args)?$Args:Args();
#-------------------------------------------------------------------------------
$EdeskID	=  (integer) @$Args['EdeskID'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('modules/Authorisation.mod','libs/Upload.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Edesk = DB_Select('Edesks',Array('ID','UserID','Flags'),Array('UNIQ','ID'=>$EdeskID));
#-------------------------------------------------------------------------------
switch(ValueOf($Edesk)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$__USER = $GLOBALS['__USER'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IsPermission = Permission_Check('TicketRead',(integer)$__USER['ID'],(integer)$Edesk['UserID']);
#-------------------------------------------------------------------------------
switch(ValueOf($IsPermission)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return ERROR | @Trigger_Error(400);
case 'false':
	return ERROR | @Trigger_Error(700);
case 'true':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($__USER['ID'] == $Edesk['UserID']){
	#-------------------------------------------------------------------------------
	if($Edesk['Flags'] == "CloseOnSee"){
		#-------------------------------------------------------------------------------
		$Comp = Comp_Load('www/API/StatusSet',Array('ModeID'=>'Edesks','IsNotNotify'=>TRUE,'IsNoTrigger'=>TRUE,'StatusID'=>'Closed','RowsIDs'=>$EdeskID,'Comment'=>'Автоматическое закрытие после просмотра пользователем'));
		#-------------------------------------------------------------------------------
		switch(ValueOf($Comp)){
		case 'error':
			return ERROR | @Trigger_Error(500);
		case 'exception':
			return ERROR | @Trigger_Error(400);
		case 'array':
			#-------------------------------------------------------------------------------
			$IsUpdate = DB_Update('Edesks',Array('Flags'=>'No','StatusDate'=>Time(),'StatusID'=>'Closed'),Array('ID'=>$EdeskID));
			if(Is_Error($IsUpdate))
				return ERROR | @Trigger_Error(500);
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Out = Array();
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$EdesksMessages = DB_Select('EdesksMessages',Array('*','(SELECT `UserID` FROM `Edesks` WHERE `Edesks`.`ID` = `EdesksMessages`.`EdeskID`) as `OwnerID`'),Array('Where'=>SPrintF('`EdeskID` = %u',$EdeskID)));
#-------------------------------------------------------------------------------
switch(ValueOf($EdesksMessages)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return $Out;
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
foreach($EdesksMessages as $EdesksMessage){
	#-------------------------------------------------------------------------------
	// минимальная обработка, удаляем текст невидимых
	if(!$EdesksMessage['IsVisible'])
		$EdesksMessage['Content'] = 'Это сообщение уже удалено...';
	#-------------------------------------------------------------------------------
	// вырезаем невидимый текст из сообщения
	$EdesksMessage['Content'] = Preg_Replace("#\[hidden\](.+)\[/hidden\]#sU",' ',$EdesksMessage['Content'], -1);
	#-------------------------------------------------------------------------------
	$Out[$EdesksMessage['ID']] = $EdesksMessage;
	#-------------------------------------------------------------------------------
	// вложения
	$Files = GetUploadedFilesInfo('EdesksMessages',$EdesksMessage['ID']);
	#-------------------------------------------------------------------------------
	if(SizeOf($Files)){
		#-------------------------------------------------------------------------------
		$Out[$EdesksMessage['ID']]['Files'] = Array();
		#-------------------------------------------------------------------------------
		foreach($Files as $File)
			$Out[$EdesksMessage['ID']]['Files'][$File['ID']] = $File;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// html
	$HTML = Comp_Load('Edesks/Text',Array('String'=>$EdesksMessage['Content'],'IsLockText'=>FALSE));
	if(Is_Error($HTML))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	$Out[$EdesksMessage['ID']]['HTML'] = $HTML;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $Out;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
