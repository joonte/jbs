<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) 
  * rewritten by Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
Header('Content-type: text/plain; charset=utf-8');
#-------------------------------------------------------------------------------
$GLOBALS['IsCron'] = TRUE;
#-------------------------------------------------------------------------------
$LockID = SPrintF('Cron[%s]',HOST_ID);
#-------------------------------------------------------------------------------
$Free = DB_Query(SPrintF("SELECT IS_FREE_LOCK('%s') as `IsFree`",$LockID));
if(Is_Error($Free))
	return ERROR | @Trigger_Error('[Demon]: не удалось проверить блокировку');
#-------------------------------------------------------------------------------
$Rows = MySQL::Result($Free);
if(Is_Error($Rows))
	return ERROR | @Trigger_Error('[Demon]: не удалось получить данные из запроса');
#-------------------------------------------------------------------------------
if(Count($Rows) < 1)
	return ERROR | @Trigger_Error('[Demon]: неверный результат запроса');
#-------------------------------------------------------------------------------
$Row = Current($Rows);
#-------------------------------------------------------------------------------
if(!$Row['IsFree'])
	return 'Cron already executing (lock is not free)...';
#-------------------------------------------------------------------------------
$Lock = DB_Query(SPrintF("SELECT GET_LOCK('%s',10) as `IsLocked`",$LockID));
if(Is_Error($Lock))
	return ERROR | @Trigger_Error('[Demon]: не удалось установить блокировку');
#-------------------------------------------------------------------------------
$Rows = MySQL::Result($Lock);
if(Is_Error($Rows))
	return ERROR | @Trigger_Error('[Demon]: не удалось получить данные из запроса');
#-------------------------------------------------------------------------------
if(Count($Rows) < 1)
	return ERROR | @Trigger_Error('[Demon]: неверный результат запроса');
#-------------------------------------------------------------------------------
$Row = Current($Rows);
#-------------------------------------------------------------------------------
if(!$Row['IsLocked'])
	return 'Cron already executing (can not set lock)...';
#-------------------------------------------------------------------------------
$Comp = Comp_Load('Users/Init',100);
if(Is_Error($Comp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Tmp = System_Element('tmp');
if(Is_Error($Tmp))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
while(TRUE){
	#-------------------------------------------------------------------------------
	// если файл существует - выходим из планировщика
	if(File_Exists(SPrintF('%s/ExitCron.txt',$Tmp))){
		#-------------------------------------------------------------------------------
		if(!UnLink(SPrintF('%s/ExitCron.txt',$Tmp)))
			return ERROR | @Trigger_Error('[comp/www/Demon]: не удалось удалить файл перезапуска планировщика');
		#-------------------------------------------------------------------------------
		echo SPrintF("%s in %s: Cron stopped by update request...\n\n",Date('Y-m-d',Time()),Date('H:i:s',Time()));
		#-------------------------------------------------------------------------------
		exit;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	for($i=1;$i<=$Config['Tasks']['PerIteration'];$i++){
		#-------------------------------------------------------------------------------
		# Реализация JBS-818
		$Tasks = Array();
		#-------------------------------------------------------------------------------
		$Task = DB_Select('Tasks', Array('ID','TypeID'), Array('Where'=>'`IsExecuted` = "no" AND `ID` IN (10,11,12)'));
		#-------------------------------------------------------------------------------
		switch(ValueOf($Task)){
		case 'error':
			return ERROR | @Trigger_Error(500);
		case 'exception':
			break;
		case 'array':
			#-------------------------------------------------------------------------------
			$Tasks = $Task;
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------
		$Where = SPrintF("`IsActive` = 'yes' AND `IsExecuted` = 'no' AND `ExecuteDate` < UNIX_TIMESTAMP() AND `Errors` < %u",$Config['Tasks']['MaxErrors']);
		#-------------------------------------------------------------------------------
		$Task = DB_Select('Tasks', Array('ID','TypeID'), Array('SortOn'=>'CreateDate', 'IsDesc'=>TRUE, 'Where'=>$Where, 'Limits'=>Array('Start'=>0,'Length'=>1)));
		#-------------------------------------------------------------------------------
		switch(ValueOf($Task)){
		case 'error':
			return ERROR | @Trigger_Error(500);
		case 'exception':
			# No more...
			break 2;
		case 'array':
			#-------------------------------------------------------------------------------
			$Tasks = $Tasks + $Task;
			#Debug(SPrintF('[comp/www/Demon]: Tasks = %s',print_r($Tasks,true)));
			#-------------------------------------------------------------------------------
			foreach ($Tasks as $Task){
				#Debug(SPrintF('[comp/www/Demon]: Task = %s',print_r($Task,true)));
				#-------------------------------------------------------------------------------
				$GLOBALS['__USER']['ID'] = 100;
				$Comp = Comp_Load('Users/Init',100);
				if(Is_Error($Comp))
					return ERROR | @Trigger_Error(500);
				#-------------------------------------------------------------------------------
				$Number = Comp_Load('Formats/Task/Number',$Task['ID']);
				if(Is_Error($Number))
					return ERROR | @Trigger_Error(500);
				#-------------------------------------------------------------------------------
				Debug(SPrintF('[comp/www/Demon]: выполнение задания #%s',$Number));
				#-------------------------------------------------------------------------------
				$IsExecute = Comp_Load('www/Administrator/API/TaskExecute',Array('TaskID'=>$Task['ID']));
				#-------------------------------------------------------------------------------
				switch(ValueOf($IsExecute)){
				case 'error':
					return ERROR | @Trigger_Error(500);
				case 'exception':
					# No more...
				case 'array':
					#-------------------------------------------------------------------------------
					$AddPrameter = '';
					#-------------------------------------------------------------------------------
					if(IsSet($GLOBALS['TaskReturnInfo'])){
						#-------------------------------------------------------------------------------
						$Array = Array();
						#-------------------------------------------------------------------------------
						if(Is_Array($GLOBALS['TaskReturnInfo'])){
							#-------------------------------------------------------------------------------
							foreach(Array_Keys($GLOBALS['TaskReturnInfo']) as $Key){
								#-------------------------------------------------------------------------------
								if(Is_Array($GLOBALS['TaskReturnInfo'][$Key])){
									#-------------------------------------------------------------------------------
									$Array[] = SPrintF('%s=>%s',$Key,Implode(',',$GLOBALS['TaskReturnInfo'][$Key]));
									#-------------------------------------------------------------------------------
								}else{
									#-------------------------------------------------------------------------------
									$Array[] = $GLOBALS['TaskReturnInfo'][$Key];
									#-------------------------------------------------------------------------------
								}
								#-------------------------------------------------------------------------------
							}
							#-------------------------------------------------------------------------------
						}else{
							#-------------------------------------------------------------------------------
							$Array[] = $GLOBALS['TaskReturnInfo'];
							#-------------------------------------------------------------------------------
						}
						#-------------------------------------------------------------------------------
						if(SizeOf($Array) > 0)
							$AddPrameter = SPrintF('[%s]',Implode('; ',$Array));
						#-------------------------------------------------------------------------------
					}
					#-------------------------------------------------------------------------------
					echo SPrintF("%s in %s: Task #%s have executed [%s] %s\n",Date('Y-m-d',Time()),Date('H:i:s',Time()),$Number,$Task['TypeID'],$AddPrameter);
					#-------------------------------------------------------------------------------
					if(IsSet($GLOBALS['TaskReturnInfo']))
						UnSet($GLOBALS['TaskReturnInfo']);
					#-------------------------------------------------------------------------------
					break;
					#-------------------------------------------------------------------------------
				default:
					return ERROR | @Trigger_Error(101);
				}
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
			break;
			#-------------------------------------------------------------------------------
		default:
			return ERROR | @Trigger_Error(101);
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	# crutch added by lissyara. With big query, system task may not execute, because
	# it executed last, after all other
	$IsUpdate = DB_Update('Tasks',Array('CreateDate'=>Time()),Array('Where'=>'`UserID` = 1'));
	if(Is_Error($IsUpdate))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$IsWrite = IO_Write(SPrintF('%s/TaskLastExecute.txt',$Tmp),Date('YmdHis'),TRUE);
	if(Is_Error($IsWrite))
		return ERROR | @Trigger_Error('[Demon_ERROR]: не удалось записать данные в маркерный файл');
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	echo SPrintF("%s in %s: Waiting %u seconds...\n\n",Date('Y-m-d',Time()),Date('H:i:s',Time()),$Config['Tasks']['SleepTime']);
	#-------------------------------------------------------------------------------
	Sleep($Config['Tasks']['SleepTime']);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$FreeLock = DB_Query(SPrintF("SELECT RELEASE_LOCK('%s')",$LockID));
if(Is_Error($FreeLock))
	return ERROR | @Trigger_Error('[Demon]: не удалось сбросить блокировку');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return Date('r');
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
