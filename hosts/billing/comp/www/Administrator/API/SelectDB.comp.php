<?php

#-------------------------------------------------------------------------------
/** @author Великодный В.В. (Joonte Ltd.) */
/******************************************************************************/
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
if(Is_Error(System_Load('modules/Authorisation.mod')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$Args = Args();
#-------------------------------------------------------------------------------
$TableID    =  (string) @$Args['TableID'];
$ColumnsIDs =   (array) @$Args['ColumnsIDs'];
$Conditions =   (array) @$Args['Conditions'];
$SortOn     =   (array) @$Args['SortOn'];
$IsDesc     = (boolean) @$Args['IsDesc'];
$Limits     =   (array) @$Args['Limits'];
#Debug(print_r($Conditions,true));
#-------------------------------------------------------------------------------
if(!$TableID)
	return new gException('WRONG_TABLE_ID','Неверное имя таблицы');
#-------------------------------------------------------------------------------
$Where = Array();
#-------------------------------------------------------------------------------
foreach($Conditions as $Condition){
	#-------------------------------------------------------------------------------
	if(Preg_Match('/([a-zA-z0-9_]+)\s{0,}([\>\<\=])\s{0,}([a-zA-zА-ЯабвгдеёжзийклмнопрстуфхцчшщьыъэюяёЁ-а-я0-9\_\-\,\.\s\@]+)/s',$Condition,$Matches))
		$Where[] = SPrintF("`%s` %s '%s'",Next($Matches),Next($Matches),Next($Matches));
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#Debug(print_r($Where,true));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$NoTypesDB = &Link_Get('NoTypesDB','boolean');
#-------------------------------------------------------------------------------
$NoTypesDB = TRUE;
#-------------------------------------------------------------------------------
Header('Content-type: text/plain; charset=utf-8');
#-------------------------------------------------------------------------------
if(!Count($ColumnsIDs))
	$ColumnsIDs = '*';
#-------------------------------------------------------------------------------
$Query = Array('IsDesc'=>$IsDesc);
#-------------------------------------------------------------------------------
if(Count($Where))
	$Query['Where'] = $Where;
#-------------------------------------------------------------------------------
if(Count($SortOn))
	$Query['SortOn'] = $SortOn;
#-------------------------------------------------------------------------------
if(Count($Limits))
	$Query['Limits'] = $Limits;
#-------------------------------------------------------------------------------
$Answer = Array();
#-------------------------------------------------------------------------------
$Rows = DB_Select($TableID,$ColumnsIDs,$Query);
#-------------------------------------------------------------------------------
$Link = &Link_Get('DB');
#-------------------------------------------------------------------------------
$Answer['Query'] = $Link->GetQuery();
#-------------------------------------------------------------------------------
switch(ValueOf($Rows)){
case 'error':
	#-------------------------------------------------------------------------------
	$__SYSLOG = &$GLOBALS['__SYSLOG'];
	#-------------------------------------------------------------------------------
	return new gException('QUERY_ERROR',Implode("\n",Array_Slice($__SYSLOG,Count($__SYSLOG)-20)));
	#-------------------------------------------------------------------------------
case 'exception':
	#-------------------------------------------------------------------------------
	$Answer['Status'] = 'Empty';
	#-------------------------------------------------------------------------------
	return $Answer;
	#-------------------------------------------------------------------------------
case 'array':
	#-------------------------------------------------------------------------------
	$Answer['Status'] = 'Ok';
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	$Types = System_XML('config/TypesDB.xml');
	if(Is_Error($Types))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	#Debug(SprintF("[comp/www/Administrator/API/SelectDB]: Types = %s",print_r($Types,true)));
	#-------------------------------------------------------------------------------
	for($i=0;$i<Count($Rows);$i++){
		#-------------------------------------------------------------------------------
		// удаляем пароли
		foreach(Array_Keys($Rows[$i]) as $Key)
			if($GLOBALS['__USER']['ID'] == 300 && IsSet($Types[$Key]) && $Types[$Key] == 'Crypt')
				$Rows[$i][$Key] = ' ***HIDDEN*** ';
		#-------------------------------------------------------------------------------
		$Rows[UniqID('ID')] = $Rows[$i];
		#-------------------------------------------------------------------------------
		UnSet($Rows[$i]);
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	$Answer['Rows'] = $Rows;
	#-------------------------------------------------------------------------------
	#Debug(SprintF("[comp/www/Administrator/API/SelectDB]: Answer[Rows] = %s",print_r($Answer['Rows'],true)));
	#-------------------------------------------------------------------------------
	return $Answer;
	#-------------------------------------------------------------------------------
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
