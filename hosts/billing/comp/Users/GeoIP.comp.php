<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('IP','IsString','UA');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
//Debug(SPrintF("[comp/Users/GeoIP]: IP = %s, UA = %s",$IP,$UA));
#-------------------------------------------------------------------------------
// IP может быть не задан (тикетница, например)
if(!$IP){
	#-------------------------------------------------------------------------------
	if($UA){
		#-------------------------------------------------------------------------------
		return HtmlSpecialChars($UA,ENT_QUOTES);
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		return '';
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(Extension_Loaded('geoip') && (geoip_db_avail(GEOIP_COUNTRY_EDITION))){
	#-------------------------------------------------------------------------------
	$Country = geoip_country_name_by_name($IP);
	#-------------------------------------------------------------------------------
	if($GeoIP = @geoip_record_by_name($IP)){
		#-------------------------------------------------------------------------------
		if($GeoIP['city'])
			$City = $GeoIP['city'];
		#-------------------------------------------------------------------------------
		if($GeoIP['country_code3'])
			$CountryCode = $GeoIP['country_code3'];
		#-------------------------------------------------------------------------------
		if(!$Country && $GeoIP['country_name'])
			$Country = $GeoIP['country_name'];
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	#Debug(SPrintF("[comp/Users/GeoIP]: @geoip_record_by_name = %s",print_r(@geoip_record_by_name($IP),true)));
	#-------------------------------------------------------------------------------
	if(!IsSet($CountryCode))
		$CountryCode = @geoip_country_code3_by_name($IP);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#Debug(SPrintF("[comp/Users/GeoIP]: @City = %s",print_r(@$City,true)));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# города бывают не всегда латиницей. пример - Орёл
if(IsSet($City))
	$City = @Iconv('UTF-8','UTF-8//IGNORE',$City);
//$City = @Iconv('','ISO-8859-1//IGNORE',$City);
#-------------------------------------------------------------------------------
#Debug(SPrintF("[comp/Users/GeoIP]: City = %s",@$City));
#-------------------------------------------------------------------------------
$IPInfo = SPrintF('IP: %s %s %s',$IP,(IsSet($Country))?SPrintF(' / %s',$Country):'GeoIP not avalible',(IsSet($City))?SPrintF(' / %s',$City):'');
//Debug(SPrintF("[comp/Users/GeoIP]: IPInfo = %s",$IPInfo));
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if($UA){
	#-------------------------------------------------------------------------------
	$InfoImage = SprintF('%s<BR />%s',HtmlSpecialChars($IPInfo,ENT_QUOTES),HtmlSpecialChars($UA,ENT_QUOTES));
	#-------------------------------------------------------------------------------
}else{
	#-------------------------------------------------------------------------------
	$InfoImage = SprintF('%s',HtmlSpecialChars($IPInfo,ENT_QUOTES));
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
// нужно в HTML, не-объект
if($IsString)
	$InfoImage = HtmlSpecialChars($InfoImage,ENT_QUOTES);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(IsSet($CountryCode) && $CountryCode){
	#-------------------------------------------------------------------------------
	$Flag = Comp_Load('Formats/CountryImage',$CountryCode,16,$InfoImage,$IsString);
	if(Is_Error($Flag))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	if($IsString){
		#-------------------------------------------------------------------------------
		return $Flag;
		#-------------------------------------------------------------------------------
	}else{
		#-------------------------------------------------------------------------------
		return new Tag('NOBODY',$Flag,new Tag('SPAN',SPrintF(' | %s',$IP)));
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}elseif($IsString){
	#-------------------------------------------------------------------------------
	return SPrintF('<IMG height="16" width="16" src="SRC:{Images/Icons/Info.gif}" align="top" onmouseover="PromptShow(event,\'%s\',this);"/>',$InfoImage);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return $IP;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
