<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('UserID','IP','UA','MessageID');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/

#-------------------------------------------------------------------------------
if(IsSet($GLOBALS['__USER']['IsEmulate']) && $GLOBALS['__USER']['IsEmulate']){
	#-------------------------------------------------------------------------------
	Debug(SPrintF('[comp/Users/LogIP]: это эмуляция, IP не логгируется'));
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
if(IsSet($GLOBALS['__USER']['IsNoLogIP'])){
	#-------------------------------------------------------------------------------
	Debug(SPrintF('[comp/Users/LogIP]: сообщение через (%s), IP не логгируется',$GLOBALS['__USER']['IsNoLogIP']));
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// кэшированные значения - не дёргаем базу
$CacheID = Md5(SPrintF('%s-%s-%s',$UserID,$IP,$UA));
#-------------------------------------------------------------------------------
if(CacheManager::get($CacheID) && !$MessageID){
	#-------------------------------------------------------------------------------
	Debug(SPrintF('[comp/Users/LogIP]: IP (%s) уже залоггирован ранее [CacheManager]',$IP));
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Other']['Modules']['Security'];
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$Array = Explode(',',$Settings['ExcludeIPs']);
#-------------------------------------------------------------------------------
foreach($Array as $ExcludeIP){
	#-------------------------------------------------------------------------------
        if(Trim($ExcludeIP) == $IP){
		#-------------------------------------------------------------------------------
                Debug(SPrintF('[comp/Users/LogIP]: IP (%s) в исключениях, не логгируется',$IP));
		#-------------------------------------------------------------------------------
		return TRUE;
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// 127.x.x.x тоже не надо логгировать
if(SubStr($IP,0,3) == '127.'){
	#-------------------------------------------------------------------------------
	Debug(SPrintF('[comp/Users/LogIP]: IP интерфейса петли (%s) не логгируется',$IP));
	#-------------------------------------------------------------------------------
	return TRUE;
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// если это сообщение в тикетницу - то логгируем обязательно
if($MessageID){
	#-------------------------------------------------------------------------------
	$Count = FALSE;
	#-------------------------------------------------------------------------------
}else{
	#-------------------------------------------------------------------------------
	// проверяем IP последнего логгированного входа, если он совпадет с текущим - ничего не делаем
	$Where = Array(
			SPrintF('`UserID` = %u',$UserID),
			SPrintF('`IP` = "%s"',$IP),
			SPrintF('`CreateDate` >  UNIX_TIMESTAMP() - 30 * 24 * 3600'),   // раз в месяц будем логгировать даже если один и тот же IP
			SPrintF('`ID` = (SELECT MAX(`ID`) FROM `UsersIPs` WHERE `UserID` = %u)',$UserID),
			);
	#-------------------------------------------------------------------------------
	$Count = DB_Count('UsersIPs',Array('Where'=>$Where));
	if(Is_Error($Count))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
if(!$Count){
	#-------------------------------------------------------------------------------
	$Array = Array('UserID'=>$UserID,'EdesksMessageID'=>($MessageID)?$MessageID:0,'IP'=>$IP,'UA'=>$UA);
	#-------------------------------------------------------------------------------
	$IsInsert = DB_Insert('UsersIPs',$Array);
	if(Is_Error($IsInsert))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	#Debug(SPrintF('[comp/Users/LogIP]: IP (%s) залоггирован',$IP));
	#-------------------------------------------------------------------------------
}else{
	#-------------------------------------------------------------------------------
	#Debug(SPrintF('[comp/Users/LogIP]: IP (%s) залоггирован ранее, пропускается',$IP));
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// кэшируем данные по IP адресу
CacheManager::add($CacheID,TRUE,30*24*60*60);
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
