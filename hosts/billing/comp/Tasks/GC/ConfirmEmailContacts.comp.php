<?php

#-------------------------------------------------------------------------------
/** @author Alex Keda, for www.host-food.ru */
/******************************************************************************/
/******************************************************************************/
$__args_list = Array('Params');
/******************************************************************************/
Eval(COMP_INIT);
/******************************************************************************/
/******************************************************************************/
$Config = Config();
#-------------------------------------------------------------------------------
$Settings = $Config['Tasks']['Types']['GC']['ConfirmEmailContacts'];
#-------------------------------------------------------------------------------
if(!$Settings['IsActive'])
	return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
// выбираем контакты Email возрастом не более месяца, не подтверждённые (код подтверждения не отсылался)
$Where = Array(
			'`CreateDate` > UNIX_TIMESTAMP() - 30 * 24 * 3600',
			'`Confirmed` < 1',
			'`MethodID` = "Email"',
			'`Confirmation` = ""'
		);
#-------------------------------------------------------------------------------
$Contacts = DB_Select('ContactsOwners', Array('ID','UserID','Address'),Array('Where'=>$Where));
#-------------------------------------------------------------------------------
switch(ValueOf($Contacts)){
case 'error':
	return ERROR | @Trigger_Error(500);
case 'exception':
	return TRUE;
case 'array':
	break;
default:
	return ERROR | @Trigger_Error(101);
}
#-------------------------------------------------------------------------------
// перебираем полученные контакты
foreach($Contacts as $Contact){
	#-------------------------------------------------------------------------------
	$Confirm = Array('Value'=>$Contact['Address'],'ContactID'=>$Contact['ID'],'Method'=>'Email','UserID'=>$Contact['UserID']);
	#-------------------------------------------------------------------------------
	$Confirm = Comp_Load('www/API/Confirm',$Confirm);
	if(!$Confirm)
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------
	#-------------------------------------------------------------------------------
	// подтверждение устаналивает глобалку в юзера которому шлётся подтверждение. надо вернуть системного
	$Init = Comp_Load('Users/Init',100);
	if(Is_Error($Init))
		return ERROR | @Trigger_Error(500);
	#-------------------------------------------------------------------------------

}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------

?>
