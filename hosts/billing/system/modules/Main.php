<?php
#-------------------------------------------------------------------------------
/** @author Бреславский А.В. (Joonte Ltd.) 
 *  rewritten by Alex Keda, for www.host-food.ru
 * */
#-------------------------------------------------------------------------------
$Args = &Args();
#-------------------------------------------------------------------------------
if(Is_Error(System_Load('classes/Session.class.php')))
	return ERROR | @Trigger_Error(500);
#-------------------------------------------------------------------------------
$__URI = $GLOBALS['__URI'];
#-------------------------------------------------------------------------------
if(SubStr($__URI,0,5) == '/API/' || SubStr($__URI,0,19) == '/Administrator/API/'){
	# no query
}else{
	#-------------------------------------------------------------------------------
	$Where = SPrintF("`Partition` = '%s'",addslashes($__URI));
	#-------------------------------------------------------------------------------
	$Clauses = DB_Select('Clauses','ID',Array('Where'=>$Where));
	#-------------------------------------------------------------------------------
	if(Is_Array($Clauses)){
		#-------------------------------------------------------------------------------
		$Clause = Current($Clauses);
		#-------------------------------------------------------------------------------
		$Args['ClauseID'] = $Clause['ID'];
		#-------------------------------------------------------------------------------
		$__URI = '/Clause';
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
$IsElement = System_Element(SPrintF('comp/www%s.comp.php',$__URI));
#-------------------------------------------------------------------------------
if(Is_Error($IsElement)){
        #-------------------------------------------------------------------------------
        if(SubStr($__URI,0,8) == '/API/v2/'){
                #-------------------------------------------------------------------------------
                $UrlParts = Preg_Split('#/#',$__URI,-1,PREG_SPLIT_NO_EMPTY);
                #-------------------------------------------------------------------------------
                //Debug(print_r($UrlParts,true));
                $IsElement = System_Element(SPrintF('comp/www/API/v2/%s.comp.php',$UrlParts[2]));
                #-------------------------------------------------------------------------------
                if(Is_Error($IsElement)){
                        #-------------------------------------------------------------------------------
                        $__URI = &$GLOBALS['__URI'];
                        #-------------------------------------------------------------------------------
                        $__URI = '/404';
                        #-------------------------------------------------------------------------------
                }else{
			#-------------------------------------------------------------------------------
			$__URI = SPrintF('/API/v2/%s',$UrlParts[2]);
			#-------------------------------------------------------------------------------
		}
                #-------------------------------------------------------------------------------
        }else{
                #-------------------------------------------------------------------------------
                $__URI = &$GLOBALS['__URI'];
                #-------------------------------------------------------------------------------
                $__URI = '/404';
                #-------------------------------------------------------------------------------
        }
        #-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
/*
$IsElement = System_Element(SPrintF('comp/www%s.comp.php',$__URI));
#-------------------------------------------------------------------------------
if(Is_Error($IsElement)){
  #-----------------------------------------------------------------------------
  $__URI = &$GLOBALS['__URI'];
  #-----------------------------------------------------------------------------
  $__URI = '/404';
}
*/
#-------------------------------------------------------------------------------
if(!In_Array($__URI,Array('/Update','/Patches'))){
	#-------------------------------------------------------------------------------
	$Session = new Session((string)@$_COOKIE['SessionID']);
	#-------------------------------------------------------------------------------
	$IsLoad = $Session->Load();
	#-------------------------------------------------------------------------------
	if(!Is_Error($IsLoad)){
		#-------------------------------------------------------------------------------
		if(IsSet($Session->Data['UsersIDs'])){
			#-------------------------------------------------------------------------------
			$UsersIDs = (array)$Session->Data['UsersIDs'];
			#-------------------------------------------------------------------------------
			if(Count($UsersIDs) > 0){
				#-------------------------------------------------------------------------------
				$UsersIDs = $Session->Data['UsersIDs'];
				#-------------------------------------------------------------------------------
				$UserID = Current($UsersIDs);
				#-------------------------------------------------------------------------------
				$IsUpdate = TRUE;/*($UserID == @$Session->Data['RootID'])*/
				#-------------------------------------------------------------------------------
				$Comp = Comp_Load('Users/Init',$UserID,$IsUpdate);
				#-------------------------------------------------------------------------------
				if(Is_Error($Comp))
					return ERROR | @Trigger_Error('[system/modules/Main]: не удалось инициализировать пользователя');
				#-------------------------------------------------------------------------------
			}
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
//Debug(print_r($UrlParts,true));
if(IsSet($UrlParts)){
	#-------------------------------------------------------------------------------
	$Result = Comp_Load(SPrintF('www%s',$__URI),$UrlParts);
	#-------------------------------------------------------------------------------
}else{
	#-------------------------------------------------------------------------------
	$Result = Comp_Load(SPrintF('www%s',$__URI));
	#-------------------------------------------------------------------------------
}
#-------------------------------------------------------------------------------
switch(ValueOf($Result)){
case 'error':
	return ERROR | @Trigger_Error('[system/modules/Main]: не удалось загрузить основной компонент системы');
case 'exception':
	#-------------------------------------------------------------------------------
	$Answer = Array('Exception'=>$Result,'Status'=>'Exception');
	#-------------------------------------------------------------------------------
	echo JSON_Encode($Answer);
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
case 'false':
	#-------------------------------------------------------------------------------
	echo JSON_Encode(Array('Status'=>'FALSE'));
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
case 'true':
	#-------------------------------------------------------------------------------
	echo JSON_Encode(Array('Status'=>'TRUE'));
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
case 'array':
	#-------------------------------------------------------------------------------
	$Result = JSON_Encode($Result);
	#-------------------------------------------------------------------------------
	Header('Content-Type: application/json; charset=utf-8');
	#-------------------------------------------------------------------------------
case 'string':
	#---------------------------------------------------------------------------
	if(!Headers_Sent()){
		#-------------------------------------------------------------------------------
		List($Micro,$Seconds) = Explode(' ',MicroTime());
		#-------------------------------------------------------------------------------
		Header(SPrintF('Waiting-Time: %01.2f sec',((float)$Micro + (float)$Seconds) - START_TIME));
		#-------------------------------------------------------------------------------
		$Size = MB_StrLen($Result,'ASCII');
		#-------------------------------------------------------------------------------
		if($Size > 30720 && Preg_Match('/gzip/',(string)@$_SERVER['HTTP_ACCEPT_ENCODING'])){
			#-------------------------------------------------------------------------------
			Header(SPrintF('Real-Content-Length: %u',$Size));
			#-------------------------------------------------------------------------------
			$Result = GzEncode($Result);
			#-------------------------------------------------------------------------------
			Header('Content-Encoding: gzip');
			#-------------------------------------------------------------------------------
			Header(SPrintF('Content-Length: %u',MB_StrLen($Result,'ASCII')));
			#-------------------------------------------------------------------------------
		}
		#-------------------------------------------------------------------------------
	}
	#-------------------------------------------------------------------------------
	echo $Result;
	#-------------------------------------------------------------------------------
	break;
	#-------------------------------------------------------------------------------
default:
	# No more...
}
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
return TRUE;
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
?>
